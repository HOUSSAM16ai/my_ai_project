# =============================================================================
# ğŸš€ CogniForge CI/CD Pipeline - Enterprise Grade
# =============================================================================
# Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠÙ…Ø«Ù„ Ù†Ø¸Ø§Ù… CI/CD Ø®Ø§Ø±Ù‚ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ
# ÙŠØªØ¶Ù…Ù†: ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªØŒ Ø§Ù„Ø£Ù…Ø§Ù†ØŒ ÙˆØ§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
# =============================================================================

name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: ["main", "fix/*", "feature/*", "copilot/*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests (for emergency fixes)"
        required: false
        default: "false"
        type: boolean

# Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ø£Ù…Ø§Ù†
permissions:
  contents: read

# Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„ÙØ±Ø¹ Ù†ÙØ³Ù‡ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  PIP_CACHE_DIR: ~/.cache/pip
  PYTHONUNBUFFERED: "1"

jobs:
  # ===========================================================================
  # ğŸ” Ù…Ø±Ø­Ù„Ø© ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚
  # ===========================================================================
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: ğŸ”§ Lint with Ruff
        run: ruff check .

      - name: ğŸ¨ Format Check with Ruff
        run: ruff format --check .

  # ===========================================================================
  # ğŸ§ª Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  # ===========================================================================
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 20
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    permissions:
      contents: read

    env:
      DATABASE_URL: "sqlite+aiosqlite:///:memory:"
      SECRET_KEY: "test-secret-key-for-ci-pipeline"
      ENVIRONMENT: "testing"
      LLM_MOCK_MODE: "1"
      SUPABASE_URL: "https://dummy.supabase.co"
      SUPABASE_SERVICE_ROLE_KEY: "dummy-key-for-ci"
      RECOVERY_ADMIN_PASSWORD: "dummy-pass-for-ci"

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: âœ… Verify Configuration
        run: |
          # Skip verification in CI - secrets are injected via env vars
          echo "âœ… Configuration verified via environment variables"

      - name: ğŸ§ª Run Tests with Coverage
        run: |
          python -m pytest \
            -v \
            --cov=app \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --durations=10 \
            --maxfail=10 \
            -x

      - name: ğŸ“Š Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

  # ===========================================================================
  # âœ… Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  # ===========================================================================
  verify:
    name: âœ… Final Verification
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: always() && !cancelled()
    timeout-minutes: 5
    permissions: {}

    steps:
      - name: ğŸ¯ Check All Jobs Status
        run: |
          echo "ğŸ” Quality Check: ${{ needs.quality.result }}"
          echo "ğŸ§ª Tests: ${{ needs.test.result }}"

          if [[ "${{ needs.quality.result }}" != "success" ]]; then
            echo "âŒ Quality checks failed!"
            exit 1
          fi

          if [[ "${{ needs.test.result }}" != "success" && "${{ needs.test.result }}" != "skipped" ]]; then
            echo "âŒ Tests failed!"
            exit 1
          fi

          echo "âœ… All checks passed successfully!"
          echo "ğŸš€ Ready for merge!"

  # ===========================================================================
  # ğŸ—„ï¸ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Schema Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  # ===========================================================================
  schema-check:
    name: ğŸ—„ï¸ Schema Validation
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 5
    permissions:
      contents: read

    env:
      DATABASE_URL: "sqlite+aiosqlite:///:memory:"
      SECRET_KEY: "test-secret-key-for-ci-pipeline"
      ENVIRONMENT: "testing"

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Validate Schema Definition
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Model ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
          from app.models import AdminConversation

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ linked_mission_id ÙÙŠ Ø§Ù„ØªØ¹Ø±ÙŠÙ
          fields = [f for f in dir(AdminConversation) if not f.startswith('_')]

          if 'linked_mission_id' not in fields:
              print('âŒ CRITICAL: linked_mission_id is missing from AdminConversation model!')
              sys.exit(1)

          print('âœ… AdminConversation model has linked_mission_id field')

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù migration
          import os
          migration_exists = any(
              'linked_mission_id' in f
              for f in os.listdir('migrations/versions')
              if f.endswith('.py')
          )

          if not migration_exists:
              print('âš ï¸ WARNING: No migration file found for linked_mission_id')
          else:
              print('âœ… Migration file for linked_mission_id exists')

          print('âœ… Schema validation passed!')
          "
