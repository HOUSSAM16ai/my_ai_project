---
# .github/workflows/ci.yml - Version 2.0 (Simplified for SQLite tests)
# ======================================================================================
# PYTHON APPLICATION CI - Required Blocking Check
# ======================================================================================
# This workflow is REQUIRED and BLOCKING - must pass for PR merge
# Focuses on: pytest with coverage (< 15 minutes)
#
# For faster checks, see: required-ci.yml (< 3 minutes)
# For heavy operations, see: microservices-ci-cd.yml (non-blocking)
# ======================================================================================

name: Python Application CI

"on":
  workflow_dispatch:

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with pytest
        env:
          FLASK_ENV: testing
          TESTING: "1"
          SECRET_KEY: test-secret-key-for-ci
        timeout-minutes: 10
        run: |
          echo "ðŸ§ª Running test suite..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Run pytest with timeout and optimized settings
          if timeout 600 pytest --verbose --tb=short \
                  --timeout=60 --timeout-method=thread \
                  -x --maxfail=5 \
                  --cov=app --cov-report=xml --cov-report=html \
                  --durations=10; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… All tests passed successfully!"

            # Save coverage for AI analysis
            if [ -f coverage.xml ]; then
              echo "ðŸ“Š Coverage report generated"
            fi

            echo "ðŸŽ¯ Test Status: SUCCESS"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Tests failed or timed out!"
            echo "ðŸ“‹ Please review the test output above"
            echo "ðŸ’¡ Tip: Use --durations=10 to see slowest tests"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
