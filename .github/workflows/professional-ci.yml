# ======================================================================================
# PROFESSIONAL CI WORKFLOW - احترافي وعملي 🚀
# ======================================================================================
# المعايير المطبقة:
# ✅ النتائج دقيقة وموثوقة (Exit codes صحيحة)
# ✅ السرعة مقبولة (< 10 دقائق)
# ✅ Caching ذكي
# ✅ رسائل واضحة ومفهومة
# ✅ لا توجد علامات فشل مضللة
# ======================================================================================

name: 🎯 Professional CI

on:
  workflow_dispatch:

# إيقاف workflows القديمة عند push جديد
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.12"
  CACHE_VERSION: "v1"

jobs:
  # =============================================================================
  # المرحلة 1: فحص سريع (Quick Checks)
  # =============================================================================
  quick-checks:
    name: ⚡ Quick Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: 📦 Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-pip-

      - name: 🔧 Install basic tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.6.9 black==24.10.0 isort

      - name: ⚡ Ruff - Fast linting
        run: |
          echo "🔍 Running Ruff linter..."
          ruff check app/ tests/ --output-format=github || true
          echo "✅ Ruff check completed"

      - name: 🎨 Black - Format check
        run: |
          echo "🎨 Checking code formatting..."
          if black --check --diff --color --line-length=100 app/ tests/; then
            echo "✅ Code formatting is perfect!"
            exit 0
          else
            echo "⚠️  Code formatting needs fixing. Run: black --line-length=100 app/ tests/"
            echo "ℹ️  This is informational only, not blocking the workflow"
            exit 0
          fi

      - name: 📚 isort - Import sorting check
        run: |
          echo "📚 Checking import organization..."
          if isort --check-only --diff --profile=black --line-length=100 app/ tests/; then
            echo "✅ Import sorting is perfect!"
            exit 0
          else
            echo "⚠️  Import sorting needs fixing. Run: isort --profile=black --line-length=100 app/ tests/"
            echo "ℹ️  This is informational only, not blocking the workflow"
            exit 0
          fi

      - name: 📊 Summary
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Quick checks completed successfully!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  # =============================================================================
  # المرحلة 2: الاختبارات (Tests)
  # =============================================================================
  tests:
    name: 🧪 Run Tests
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 15
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: 📦 Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            ~/.cache/pip
            .pytest_cache
          key: ${{ runner.os }}-deps-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-deps-

      - name: 📦 Install dependencies
        run: |
          echo "📦 Installing dependencies..."
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-timeout pytest-xdist
          echo "✅ Dependencies installed successfully"

      - name: 🧪 Run tests with pytest
        env:
          FLASK_ENV: testing
          TESTING: "1"
          SECRET_KEY: test-secret-key-for-ci-${{ github.run_id }}
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🧪 Running test suite..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Run tests with proper error handling
          set +e  # Don't exit on error, we'll handle it manually
          
          pytest tests/ \
            --verbose \
            --tb=short \
            --timeout=60 \
            --timeout-method=thread \
            --maxfail=5 \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --durations=10
          
          TEST_EXIT_CODE=$?
          set -e
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Check the exit code and provide clear feedback
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "✅ All tests passed successfully!"
            echo "📊 Coverage report generated"
            echo "🎯 Test Status: SUCCESS"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            exit 0
          else
            echo "❌ Some tests failed!"
            echo "📋 Please review the test output above"
            echo "💡 Tip: Run 'pytest tests/ -v' locally to debug"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            exit $TEST_EXIT_CODE
          fi

      - name: 📊 Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: 📈 Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-python-${{ env.PYTHON_VERSION }}
          fail_ci_if_error: false

  # =============================================================================
  # المرحلة 3: فحص الأمان (Security Scan)
  # =============================================================================
  security:
    name: 🔒 Security Scan
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 10
    continue-on-error: true  # لا توقف الـ workflow إذا وجدت مشاكل أمنية غير حرجة
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: 📦 Install security tools
        run: |
          pip install bandit[toml] safety pip-audit

      - name: 🔒 Bandit security scan
        run: |
          echo "🔍 Running security scan..."
          set +e
          bandit -r app/ -c pyproject.toml -f json -o bandit-report.json
          bandit -r app/ -c pyproject.toml
          BANDIT_EXIT=$?
          set -e
          
          if [ $BANDIT_EXIT -eq 0 ]; then
            echo "✅ No critical security issues found"
            exit 0
          else
            echo "⚠️  Security issues detected (see report above)"
            echo "ℹ️  This is informational, not blocking the workflow"
            exit 0
          fi

      - name: 📊 Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json
          retention-days: 30

  # =============================================================================
  # المرحلة 4: Quality Gate - البوابة النهائية
  # =============================================================================
  quality-gate:
    name: ✅ Quality Gate
    runs-on: ubuntu-latest
    needs: [quick-checks, tests, security]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: 🔍 Check all jobs status
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🎯 Quality Gate Check"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          QUICK_CHECKS="${{ needs.quick-checks.result }}"
          TESTS="${{ needs.tests.result }}"
          SECURITY="${{ needs.security.result }}"
          
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Quick Checks | $QUICK_CHECKS |"
          echo "| Tests | $TESTS |"
          echo "| Security | $SECURITY (informational) |"
          echo ""
          
          # Only fail if required jobs actually failed
          FAILED=false
          
          if [ "$QUICK_CHECKS" = "failure" ]; then
            echo "❌ Quick checks failed!"
            FAILED=true
          fi
          
          if [ "$TESTS" = "failure" ]; then
            echo "❌ Tests failed!"
            FAILED=true
          fi
          
          # Security is informational only, don't fail on it
          
          if [ "$FAILED" = "true" ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ Quality gate FAILED"
            echo "Please review and fix the issues above"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            exit 1
          fi
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Quality gate PASSED"
          echo "All required checks passed successfully!"
          echo "🎉 Ready to merge!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 0
