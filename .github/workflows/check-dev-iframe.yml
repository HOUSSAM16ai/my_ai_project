name: check-dev-iframe
on: [pull_request]

jobs:
  iframe_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create dummy frontend assets
        run: mkdir -p app/static/dist

      - name: Run server in background
        env:
          ENVIRONMENT: development
          SECRET_KEY: "super_secret_ci_key"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &>/tmp/uvicorn.log &
          sleep 5

      - name: Check headers
        run: |
          # Verify server is up first
          if ! curl -s -I http://127.0.0.1:8000 > /dev/null; then
            echo "CRITICAL: Server is not reachable!"
            echo "--- Uvicorn Logs ---"
            cat /tmp/uvicorn.log
            echo "--------------------"
            exit 1
          fi

          # Ensure X-Frame-Options is NOT present
          if curl -I http://127.0.0.1:8000 | grep -i 'x-frame-options'; then
            echo "FAIL: x-frame-options header found!"
            exit 1
          else
            echo "PASS: No x-frame-options header."
          fi

          # Ensure CSP allows framing (frame-ancestors *)
          if curl -I http://127.0.0.1:8000 | grep -i 'content-security-policy' | grep -F "frame-ancestors *"; then
            echo "PASS: CSP contains frame-ancestors *"
          else
            echo "FAIL: CSP does not contain frame-ancestors *"
            echo "Actual Headers:"
            curl -I http://127.0.0.1:8000
            exit 1
          fi
