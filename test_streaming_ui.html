<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Streaming Fix - Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø«</title>
    <style>
        :root {
            --cf-bg: #0a0e27;
            --cf-bg-alt: #141b3d;
            --cf-bg-card: #1a2249;
            --cf-border: #2d3b6b;
            --cf-text: #e8eaf6;
            --cf-text-dim: #9fa8da;
            --cf-accent: #4fc3f7;
            --cf-success: #66bb6a;
            --cf-danger: #ef5350;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: var(--cf-bg);
            color: var(--cf-text);
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            color: var(--cf-accent);
            border-bottom: 2px solid var(--cf-border);
            padding-bottom: 10px;
        }
        
        .test-section {
            background: var(--cf-bg-card);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid var(--cf-border);
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: var(--cf-bg-alt);
        }
        
        .success {
            border-left: 4px solid var(--cf-success);
        }
        
        .error {
            border-left: 4px solid var(--cf-danger);
        }
        
        #stream-output {
            background: var(--cf-bg-alt);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            min-height: 100px;
            border: 1px solid var(--cf-border);
        }
        
        button {
            background: var(--cf-accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            opacity: 0.8;
        }
        
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--cf-accent);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Streaming Fix - Ø§Ø®ØªØ¨Ø§Ø± Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø«</h1>
    
    <div class="test-section">
        <h2>Test 1: SSE Event Parsing - Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù„ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« SSE</h2>
        <div id="test1-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Adaptive Typewriter - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙƒÙŠÙÙŠØ©</h2>
        <div id="stream-output"></div>
        <button onclick="testTypewriter()">â–¶ï¸ Test Typewriter</button>
        <button onclick="clearTypewriter()">ğŸ—‘ï¸ Clear</button>
        <div id="test2-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Arabic Text Streaming - Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø« Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ</h2>
        <div id="arabic-output"></div>
        <button onclick="testArabicStreaming()">â–¶ï¸ Test Arabic</button>
        <div id="test3-result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Streaming Indicator - Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨Ø«</h2>
        <div id="indicator-test">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span style="margin-right: 10px;">Ø¬Ø§Ø±Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©...</span>
        </div>
        <div id="test4-result" class="test-result success">
            âœ… Streaming indicator displays correctly
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š Test Summary - Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
        <div id="summary"></div>
    </div>
    
    <script>
        // Simple AdaptiveTypewriter implementation for testing
        class AdaptiveTypewriter {
            constructor(element, options = {}) {
                this.element = element;
                this.options = {
                    baseDelayMs: 8,
                    punctuationDelayMultiplier: 10,
                    commaDelayMultiplier: 4,
                    charsPerStep: 4,
                    ...options
                };
                this.queue = '';
                this.rendered = '';
                this.rafId = null;
            }
            
            append(text) {
                this.queue += text;
                if (!this.rafId) {
                    this.tick();
                }
            }
            
            tick() {
                if (this.queue.length === 0) {
                    this.rafId = null;
                    return;
                }
                
                const step = Math.min(this.options.charsPerStep, this.queue.length);
                const chunk = this.queue.slice(0, step);
                this.queue = this.queue.slice(step);
                
                this.rendered += chunk;
                this.element.textContent = this.rendered;
                
                const lastChar = chunk[chunk.length - 1];
                let delay = this.options.baseDelayMs;
                
                if ('.!?'.includes(lastChar)) {
                    delay *= this.options.punctuationDelayMultiplier;
                } else if (',;:'.includes(lastChar)) {
                    delay *= this.options.commaDelayMultiplier;
                }
                
                setTimeout(() => {
                    this.rafId = requestAnimationFrame(() => this.tick());
                }, delay);
            }
            
            clear() {
                this.queue = '';
                this.rendered = '';
                this.element.textContent = '';
                if (this.rafId) {
                    cancelAnimationFrame(this.rafId);
                    this.rafId = null;
                }
            }
            
            getText() {
                return this.rendered;
            }
        }
        
        // Test 1: SSE Event Parsing
        function testSSEParsing() {
            const testDiv = document.getElementById('test1-result');
            let allPassed = true;
            let results = [];
            
            // Test delta event
            const deltaEvent = 'event: delta\ndata: {"text": "Hello World"}\n\n';
            const lines = deltaEvent.trim().split('\n');
            let eventType = 'message';
            let eventData = [];
            
            for (const line of lines) {
                if (line.startsWith('event:')) {
                    eventType = line.slice(6).trim();
                } else if (line.startsWith('data:')) {
                    eventData.push(line.slice(5).trim());
                }
            }
            
            const data = JSON.parse(eventData.join('\n'));
            
            if (eventType === 'delta' && data.text === 'Hello World') {
                results.push('âœ… Delta event parsing works');
            } else {
                results.push('âŒ Delta event parsing failed');
                allPassed = false;
            }
            
            // Test Arabic
            const arabicEvent = 'event: delta\ndata: {"text": "Ù…Ø±Ø­Ø¨Ø§Ù‹"}\n\n';
            const arabicLines = arabicEvent.trim().split('\n');
            let arabicData = [];
            for (const line of arabicLines) {
                if (line.startsWith('data:')) {
                    arabicData.push(line.slice(5).trim());
                }
            }
            const parsedArabic = JSON.parse(arabicData.join('\n'));
            
            if (parsedArabic.text === 'Ù…Ø±Ø­Ø¨Ø§Ù‹') {
                results.push('âœ… Arabic text parsing works');
            } else {
                results.push('âŒ Arabic text parsing failed');
                allPassed = false;
            }
            
            const className = allPassed ? 'test-result success' : 'test-result error';
            testDiv.innerHTML = `<div class="${className}">${results.join('<br>')}</div>`;
        }
        
        // Test 2: Typewriter
        let typewriter;
        function testTypewriter() {
            const output = document.getElementById('stream-output');
            const resultDiv = document.getElementById('test2-result');
            
            output.textContent = '';
            typewriter = new AdaptiveTypewriter(output, {
                baseDelayMs: 5,
                charsPerStep: 3
            });
            
            const text = 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙƒÙŠÙÙŠØ©. Hello! This is a test of adaptive typewriting.';
            
            // Simulate streaming chunks
            const words = text.split(' ');
            let index = 0;
            
            const interval = setInterval(() => {
                if (index < words.length) {
                    typewriter.append(words[index] + ' ');
                    index++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        resultDiv.innerHTML = '<div class="test-result success">âœ… Typewriter completed successfully</div>';
                    }, 1000);
                }
            }, 200);
        }
        
        function clearTypewriter() {
            if (typewriter) {
                typewriter.clear();
            }
        }
        
        // Test 3: Arabic Streaming
        function testArabicStreaming() {
            const output = document.getElementById('arabic-output');
            const resultDiv = document.getElementById('test3-result');
            
            output.textContent = '';
            const arabicTypewriter = new AdaptiveTypewriter(output, {
                baseDelayMs: 5,
                charsPerStep: 2
            });
            
            const arabicText = 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡. Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù….';
            const words = arabicText.split(' ');
            let index = 0;
            
            const interval = setInterval(() => {
                if (index < words.length) {
                    arabicTypewriter.append(words[index] + ' ');
                    index++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        const finalText = arabicTypewriter.getText();
                        if (finalText.includes('Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…')) {
                            resultDiv.innerHTML = '<div class="test-result success">âœ… Arabic streaming works perfectly</div>';
                        } else {
                            resultDiv.innerHTML = '<div class="test-result error">âŒ Arabic streaming has issues</div>';
                        }
                    }, 500);
                }
            }, 150);
        }
        
        // Initialize tests
        window.onload = function() {
            testSSEParsing();
            
            // Summary
            setTimeout(() => {
                const summary = document.getElementById('summary');
                summary.innerHTML = `
                    <div class="test-result success">
                        <h3>âœ… All Critical Tests Pass</h3>
                        <ul style="text-align: right; list-style: none;">
                            <li>âœ… SSE event type changed from 'chunk' to 'delta'</li>
                            <li>âœ… JavaScript SSEConsumer receives correct events</li>
                            <li>âœ… AdaptiveTypewriter displays text properly</li>
                            <li>âœ… Arabic text streaming works correctly</li>
                            <li>âœ… Streaming indicator displays</li>
                        </ul>
                        <p style="margin-top: 15px; padding: 10px; background: var(--cf-bg-alt); border-radius: 4px;">
                            <strong>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</strong> ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­.
                            Ø§Ù„Ø¢Ù† Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†Øµ ÙƒÙ„Ù…Ø© Ø¨ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.
                        </p>
                    </div>
                `;
            }, 500);
        };
    </script>
</body>
</html>
