# =====================================================================
# NGINX SSE STREAMING CONFIGURATION
# =====================================================================
# This configuration prevents buffering and caching that kills SSE
#
# Usage:
#   Include this file in your nginx server block:
#   
#   server {
#       location /api/v1/stream/ {
#           include /path/to/sse.conf;
#           proxy_pass http://backend;
#       }
#   }

# Use HTTP/1.1 for proper streaming support
proxy_http_version 1.1;

# Clear the Connection header to allow keep-alive
proxy_set_header Connection "";

# Enable chunked transfer encoding
chunked_transfer_encoding on;

# CRITICAL: Disable proxy buffering (kills SSE if enabled)
proxy_buffering off;

# Disable caching
proxy_cache off;

# Disable response compression (can interfere with streaming)
gzip off;

# Set generous timeouts for long-running streams
proxy_read_timeout 3600s;  # 1 hour
proxy_send_timeout 3600s;  # 1 hour
proxy_connect_timeout 60s;

# Pass through important headers
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# Pass through the Cache-Control header from backend
proxy_pass_header Cache-Control;

# Explicitly set Cache-Control to prevent any caching
add_header Cache-Control "no-cache, no-transform" always;

# For EventSource reconnection support
proxy_pass_header Last-Event-ID;

# Ensure no buffering at any level
proxy_request_buffering off;
proxy_buffering off;

# Optional: Enable access log for debugging
# access_log /var/log/nginx/sse_access.log;
# error_log /var/log/nginx/sse_error.log;
