# docker-compose.yml (Cloud-Native Development v5.0)
services:
  # --- [REMOVED] The local db service is no longer needed. ---
  # db: ...

  # --- [REMOVED] The local chroma service is no longer needed. ---
  # chroma: ...
  
  # Migrations will now run against the Azure DB
  migrations:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flask-migrations
    init: true
    volumes:
      - .:/app
    command: ["flask", "db", "upgrade"]
    env_file:
      - .env
    environment:
      # We no longer need POSTGRES_HOST, as the full URL is in .env
      - FLASK_APP=run.py
    networks: [appnet]

  # AI service remains for now, but its role might change
  ai_service:
    build:
      context: ./ai_service
    container_name: fastapi-ai-service
    init: true
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./ai_service:/code
    command: sh -c "./entrypoint.sh"
    depends_on:
      # It now only depends on migrations completing successfully against Azure
      migrations:
        condition: service_completed_successfully
    ports:
      - "8000:8000"
    networks: [appnet]

  # Web service will now connect to Azure services
  web:
    build:
      context: .
    container_name: flask-frontend
    init: true
    restart: unless-stopped
    env_file:
      - .env
    command: gunicorn "run:app" --bind=0.0.0.0:5000 --worker-tmp-dir /app/tmp
    volumes:
      - .:/app
    depends_on:
      migrations:
        condition: service_completed_successfully
      ai_service:
        condition: service_started # No longer needs to be healthy, just started
    ports:
      - "5000:5000"
    networks: [appnet]


# We no longer need local volumes for databases
volumes: {}

networks:
  appnet:
    driver: bridge