# ملاحظة: حذفنا رقم الإصدار version لأنه لم يعد مطلوباً

# --- 1. هذا هو الجزء المفقود (التعريف) ---
# يجب أن يبدأ بـ x- وعلامة & ليعرف البرنامج أن هذا "قالب"
x-common-environment: &common-environment
  # ضع متغيرات البيئة الخاصة بك هنا
  ADMIN_EMAIL: ${ADMIN_EMAIL}
  ADMIN_NAME: ${ADMIN_NAME}
  ADMIN_PASSWORD: ${ADMIN_PASSWORD}
  DATABASE_URL: ${DATABASE_URL}
  OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
  SECRET_KEY: ${SECRET_KEY}
  # يمكنك إضافة أي متغيرات أخرى تحتاجها هنا

services:
  # ----------------------------------------------------------------------------------
  # The Unified Reality Kernel Service
  # ----------------------------------------------------------------------------------
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cogniforge-unified-reality
    restart: unless-stopped
    
    # توحيد المنافذ
    ports:
      - "8000:8000"
      
    networks:
      - appnet
      
    environment:
      # --- 2. هنا يتم الاستدعاء (الذي سبب الخطأ سابقاً) ---
      # الآن سيعمل لأنه سيجد التعريف في الأعلى
      <<: *common-environment
      PORT: 8000
      
    # فحص الصحة
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Automated Zero-Touch Deployment Command
    # Runs smart migration (safe for existing DBs), seeds admin, then starts app
    command: /bin/sh -c "python scripts/smart_migrate.py && python scripts/seed_admin.py && uvicorn app.main:app --host 0.0.0.0 --port 8000 --proxy-headers"

networks:
  appnet:
    driver: bridge
