# ุฏููู ุงูุจุซ ุงูุฎุงุฑู (SSE Streaming) - ูุฑุฌุน ุณุฑูุน ๐

## ุงููุดููุฉ ุงูุฃุตููุฉ

**ุงูุฎุทุฃ**: "Stream connection error" ุจุนุฏ ุฃูู ุณุคุงู

**ุงูุณุจุจ**:
1. ุชููุฆุฉ SSE ุบูุฑ ุตุญูุญุฉ
2. ุชุฎุฒูู ูุคูุช ูู Proxy
3. ุบูุงุจ Heartbeats
4. ุนุฏู ุชูุฑูุบ ุงููุฎุฒู (flush)
5. ูุงุฑุฆ Frontend ูุง ูุชุนุงูู ูุน UTF-8 ูุชุนุฏุฏ ุงูุจุงูุชุงุช

## ุงูุญู ุงูุฎุงุฑู โจ

### ุงูุฎุงุฏู (Backend)

#### ููู ุฌุฏูุฏ: `app/api/stream_routes.py`
```python
# ููุทุฉ ููุงูุฉ SSE ุฎุงุฑูุฉ ูุน:
- ุชูุณูู ุฃุญุฏุงุซ SSE ุตุญูุญ
- ูุจุถุงุช ููุจ ูู 20 ุซุงููุฉ (ping)
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
- ุฏุนู ุฅุนุงุฏุฉ ุงูุงุชุตุงู
- ุฃุญุฏุงุซ ุชูุฏู ููููุงู (ุตูุฑุ ููุฏููุ PDF)
```

#### ุชุญุฏูุซ: `app/admin/routes.py`
```python
# ุฅุถุงูุฉ ุฑุคูุณ HTTP ุตุญูุญุฉ:
headers = {
    "Cache-Control": "no-cache, no-transform",  # ููุน ุงูุชุฎุฒูู
    "Content-Type": "text/event-stream; charset=utf-8",
    "X-Accel-Buffering": "no",  # ุชุนุทูู ุชุฎุฒูู NGINX
}
```

### ุงููุงุฌูุฉ (Frontend)

#### ููู ุฌุฏูุฏ: `app/static/js/useSSE.js`

**SSEConsumer - ูุณุชููู ุฎุงุฑู ููุฃุญุฏุงุซ:**
```javascript
const consumer = new SSEConsumer('/api/v1/stream/chat?q=ุณุคุงูู');

consumer.onDelta((data) => {
  // ุฅุถุงูุฉ ุงููุต ุชุฏุฑูุฌููุง
  displayText += data.text;
});

consumer.onComplete(() => {
  console.log('ุงูุชูู ุงูุจุซ! โ');
});

consumer.connect();
```

**ุงููููุฒุงุช ุงูุฎุงุฑูุฉ:**
- โ **TextDecoder ูุน stream=true** - ูุชุนุงูู ูุน UTF-8 ุงูุนุฑุจู ุจุดูู ุตุญูุญ
- โ **ุชุญููู ุณุทุฑ ุจุณุทุฑ** - ูุญุชุฑู ุญุฏูุฏ SSE (\n\n)
- โ **ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆูุฉ** - ูุณุชุฎุฏู Last-Event-ID
- โ **ุงุณุชุฑุฌุงุน ูู ุงูุฃุฎุทุงุก** - ูุญุงููุฉ ูุฌุฏุฏุฉ ูุน ุชุฃุฎูุฑ ุชุตุงุนุฏู

**AdaptiveTypewriter - ุขูุฉ ูุงุชุจุฉ ุฐููุฉ:**
```javascript
const typewriter = new AdaptiveTypewriter(element, {
  baseDelayMs: 8,                    // ุณุฑุนุฉ ุฃุณุงุณูุฉ
  punctuationDelayMultiplier: 10,    // ุฃุจุทุฃ ุนูุฏ ุงูููุงุท
  commaDelayMultiplier: 4,           // ูุชูุณุท ุนูุฏ ุงูููุงุตู
  charsPerStep: 4                    // ุฃุญุฑู ููู ุฏูุนุฉ
});

typewriter.append('ูุฑุญุจุงู ุจู!');
```

**ุงูุชุฃุซูุฑ**: ุณุฑุนุฉ ูุชูููุฉ ุญุณุจ ุนูุงูุงุช ุงูููู ููุฑุงุกุฉ ุฃูุถู!

### ุงูุจููุฉ ุงูุชุญุชูุฉ (Infrastructure)

#### ููู: `infra/nginx/sse.conf`

```nginx
# ุฅุนุฏุงุฏุงุช NGINX ุงูุญุฑุฌุฉ ููุจุซ:
proxy_buffering off;          # ุญุฑุฌ: ุชุนุทูู ุงูุชุฎุฒูู ุงููุคูุช
proxy_cache off;              # ูุง ุชุฎุฒูู
gzip off;                     # ูุง ุถุบุท
proxy_read_timeout 3600s;     # ูููุฉ ุณุงุนุฉ
proxy_http_version 1.1;       # HTTP/1.1 ูุทููุจ
```

**ุงูุงุณุชุฎุฏุงู:**
```nginx
location /api/v1/stream/ {
    include /path/to/infra/nginx/sse.conf;
    proxy_pass http://backend;
}
```

## ุฃููุงุน ุงูุฃุญุฏุงุซ

| ุงูุญุฏุซ | ุงูุจูุงูุงุช | ุงูุบุฑุถ |
|-------|----------|--------|
| `hello` | `{ts, model}` | ุงูุงุชุตุงู ุชู |
| `start` | `{status}` | ุจุฏุฃ ุงูุจุซ |
| `delta` | `{text}` | ุฌุฒุก ูู ุงููุญุชูู |
| `done` | `{reason}` | ุงูุชูู ุงูุจุซ |
| `error` | `{message}` | ุญุฏุซ ุฎุทุฃ |
| `ping` | `"๐ง"` | ูุจุถุฉ ููุจ |

## ุงูุงุณุชุฎุฏุงู ุงูุณุฑูุน

### 1. ุชุดุบูู ูุญูููุง
```bash
cd /home/runner/work/my_ai_project/my_ai_project
flask run
```

### 2. ุงุฎุชุจุงุฑ SSE
```bash
curl -N "http://localhost:5000/api/v1/stream/chat?q=ูุฑุญุจุง"
```

### 3. ูุชุญ ุงููุชุตูุญ
```
http://localhost:5000/admin/dashboard
```

## ุญู ุงููุดุงูู ุงูุดุงุฆุนุฉ

### ุงููุดููุฉ: "Stream connection error"

**ุงูุญููู:**
1. โ ุชุญูู ูู ุฅุนุฏุงุฏุงุช NGINX: `proxy_buffering off`
2. โ ุชุญูู ูู ุงูุฑุคูุณ: `Content-Type: text/event-stream`
3. โ ุชุญูู ูู ุงููููุงุช: ูุฌุจ ุฃู ุชููู โฅ120 ุซุงููุฉ
4. โ ุงุฎุชุจุฑ ูุจุงุดุฑุฉ: `curl -N` ูุชุฌุงูุฒ NGINX

### ุงููุดููุฉ: ุงูุจุซ ูุชููู ูู ุงูููุชุตู

**ุงูุญููู:**
1. โ ุชูุนูู ุงููุจุถุงุช: ููุฌูุฏุฉ (ูู 20 ุซุงููุฉ)
2. โ ุชุญูู ูู ุณุฌูุงุช ุงูุฎุงุฏู
3. โ ุฒูุงุฏุฉ ุงููููุงุช
4. โ ุชูุนูู ุฅุนุงุฏุฉ ุงูุงุชุตุงู: `reconnect: true`

### ุงููุดููุฉ: ุฃุญุฑู UTF-8 ูุดููุฉ

**ุงูุญููู:**
1. โ ุงุณุชุฎุฏู TextDecoder: ููุฌูุฏ ูุน `stream: true`
2. โ ุชุนููู charset: ุงูุฎุงุฏู ูุฑุณู `charset=utf-8`
3. โ ุชุญูู ูู ุงูุชุฑููุฒ: ุงูุณูุฑูุฑ ููุงุนุฏุฉ ุงูุจูุงูุงุช UTF-8

## ุงููุดุฑ ุนูู ุงูุฅูุชุงุฌ

### ูุน NGINX
```bash
# 1. ุงูุณุฎ ุงูุฅุนุฏุงุฏุงุช
sudo cp infra/nginx/sse.conf /etc/nginx/conf.d/

# 2. ุงุฎุชุจุฑ
sudo nginx -t

# 3. ุฃุนุฏ ุงูุชุญููู
sudo systemctl reload nginx
```

### ูุน Cloudflare
```
โ๏ธ ุชุญุฐูุฑ: Cloudflare ูุฏ ูุชุฏุงุฎู ูุน SSE

ุงูุญู:
1. ุฃูุดุฆ ูุทุงู ูุฑุนู: stream.yourdomain.com
2. ูุฌูู ูุจุงุดุฑุฉ ููุณูุฑูุฑ (ุชุฌุงูุฒ Cloudflare)
3. ุงุณุชุฎุฏูู ูููุงุท ููุงูุฉ SSE ููุท
```

### ูุน Vercel
```
โ๏ธ ุชุญุฐูุฑ: Vercel Serverless ูู ูููุฉ 10-60 ุซุงููุฉ

ุงูุญู:
1. ุงุณุชุฎุฏู Edge Runtime
2. ุฃู ุงููู ุงูุจุซ ูุฎุฏูุฉ ุฎุงุฑุฌูุฉ (Railway, Fly.io)
```

## ุงูุฃุฏุงุก ุงูุฃูุซู

### ุงูุฎุงุฏู
```python
# ุญุฌู ุฌุฒุก ูุซุงูู: 3-8 ูููุงุช
OPTIMAL_CHUNK_SIZE = 6

# ุฃุฑุณู ุนูุฏ ุนูุงูุงุช ุงูููู
if token_count % 6 == 0 or token[-1] in ".!?,;:":
    yield sse_event("delta", {"text": buffer})
```

### ุงููุงุฌูุฉ
```javascript
// ุณุฑุนุงุช ุขูุฉ ุงููุงุชุจุฉ
baseDelayMs: 5-10,              // ูุต ุนุงุฏู
punctuationDelayMultiplier: 8,   // ุฃุจุทุฃ ุนูุฏ ุงูุฌูู
commaDelayMultiplier: 3,         // ูุชูุณุท ุนูุฏ ุงูููุงุตู
```

## ุงูููุฒุงุช ุงููุณุชูุจููุฉ ๐

### ุงููุฑุญูุฉ 2: WebSocket Fallback
```javascript
// ุชุจุฏูู ุชููุงุฆู ูู WebSocket
if (!window.EventSource) {
  consumer = new WebSocketConsumer(url);
}
```

### ุงููุฑุญูุฉ 3: ุงููุณุงุฆุท ุงููุชุนุฏุฏุฉ

**ุชูููุฏ ุงูุตูุฑ:**
```javascript
consumer.onProgress((data) => {
  progressBar.style.width = data.pct + '%';
});

consumer.onPreview((data) => {
  img.src = data.url;  // ูุนุงููุฉ ุชุฏุฑูุฌูุฉ
});
```

**ุจุซ ุงูุตูุช (TTS):**
```javascript
const audioStream = new AudioStreamConsumer('/api/v1/stream/tts');
audioStream.onChunk((audioData) => {
  playAudio(audioData);
});
```

**ููุฏูู/AR/3D:**
- WebRTC ููููุฏูู ุงูุญู
- three.js/Babylon.js ูููุงุฐุฌ 3D
- WebXR ูุชุฌุงุฑุจ AR

## ุงูุฃูุงู

### ุงูุชุญูู ูู ุงููุฏุฎูุงุช
```python
MAX_QUESTION_LENGTH = 10000
if len(question) > MAX_QUESTION_LENGTH:
    yield sse_event("error", {"message": "ุงูุณุคุงู ุทููู ุฌุฏูุง"})
```

### ุชุญุฏูุฏ ุงููุนุฏู
```python
@limiter.limit("5 per minute")
@bp.route("/chat")
def sse_chat():
    # 5 ุทูุจุงุช ูุญุฏ ุฃูุตู ูู ุงูุฏูููุฉ
```

### ุงููุตุงุฏูุฉ
```python
@bp.route("/chat")
@login_required
def sse_chat():
    # ุงููุณุชุฎุฏููู ุงููุณุฌููู ููุท
```

## ุงููุฑุงูุจุฉ

### ุงูููุงููุณ ุงูุฑุฆูุณูุฉ
```python
- ุนุฏุฏ ุงุชุตุงูุงุช SSE ุงููุดุทุฉ
- ูุชูุณุท ูุฏุฉ ุงูุจุซ
- ูุนุฏู ุงูุฃุฎุทุงุก
- ูุนุฏู ุงููุทุงุน ุงููุจุถ
- ูุญุงููุงุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู
- ุงูุจุงูุชุงุช ุงููููููุฉ
```

## ุงูุฎูุงุตุฉ

ูุฐุง ุงูุชูููุฐ ูููุฑ:
- โ **ุจุซ SSE ููู** ูุญู ูุดููุฉ "Stream connection error"
- โ **ุฏุนู UTF-8 ูุชุนุฏุฏ ุงูุจุงูุชุงุช** ูููุตูุต ุงูุนุฑุจูุฉ
- โ **ุฅุนุงุฏุฉ ุงุชุตุงู ูุงุณุชุฑุฌุงุน ูู ุงูุฃุฎุทุงุก** ููููุซูููุฉ
- โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ** ูุน ุขูุฉ ูุงุชุจุฉ ุฐููุฉ
- โ **ุฌุงูุฒ ููุฅูุชุงุฌ** ูุน ุฃุฏูุฉ NGINXุ Cloudflareุ Vercel
- โ **ุฌุงูุฒ ูููุณุชูุจู** ูุจุซ ุงููุณุงุฆุท ุงููุชุนุฏุฏุฉ

**ูุจูู ุจู โค๏ธ ูู ุญุณุงู ุจู ูุฑุงุญ**

---

ููุฃุณุฆูุฉ ุฃู ุงููุดุงููุ ุฑุงุฌุน:
- ุงูุฎุงุฏู: `app/api/stream_routes.py`
- ุงููุงุฌูุฉ: `app/static/js/useSSE.js`
- ุงูุจููุฉ ุงูุชุญุชูุฉ: `infra/nginx/sse.conf`
- ุงูุฏููู ุงููุงูู: `SSE_STREAMING_GUIDE.md`
