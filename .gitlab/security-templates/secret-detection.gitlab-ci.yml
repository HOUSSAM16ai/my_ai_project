# ======================================================================================
# Secret Detection Configuration
# ======================================================================================
# Multi-tool secret scanning to prevent credential leaks

.secret_base:
  stage: security
  artifacts:
    paths:
      - secrets-report.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# detect-secrets - Yelp's secret scanner
secret:detect-secrets:
  extends: .secret_base
  image: python:3.12-slim
  before_script:
    - pip install detect-secrets
  script:
    - echo "ğŸ” Detecting secrets with detect-secrets..."
    - |
      detect-secrets scan \
        --all-files \
        --force-use-all-plugins \
        --exclude-files '\.git/.*' \
        --exclude-files '.*\.lock' \
        --exclude-files 'node_modules/.*' > secrets-detect.json || true
    - |
      if [ -s secrets-detect.json ]; then
        echo "âš ï¸ Potential secrets detected!"
        cat secrets-detect.json
      else
        echo "âœ… No secrets detected"
      fi
  artifacts:
    paths:
      - secrets-detect.json

# GitLeaks - Git-focused secret scanner
secret:gitleaks:
  extends: .secret_base
  image: zricethezav/gitleaks:latest
  script:
    - echo "ğŸ” Scanning for secrets with GitLeaks..."
    - |
      gitleaks detect \
        --source . \
        --report-format json \
        --report-path secrets-gitleaks.json \
        --verbose || true
    - |
      if [ -s secrets-gitleaks.json ]; then
        echo "âš ï¸ GitLeaks found potential secrets!"
        cat secrets-gitleaks.json
      else
        echo "âœ… No secrets found by GitLeaks"
      fi
  artifacts:
    paths:
      - secrets-gitleaks.json

# TruffleHog - High-entropy secret scanner
secret:trufflehog:
  extends: .secret_base
  image: trufflesecurity/trufflehog:latest
  script:
    - echo "ğŸ” Scanning with TruffleHog..."
    - |
      trufflehog filesystem . \
        --json \
        --no-update > secrets-trufflehog.json || true
    - |
      if [ -s secrets-trufflehog.json ]; then
        echo "âš ï¸ TruffleHog found potential secrets!"
        cat secrets-trufflehog.json | head -50
      else
        echo "âœ… No secrets found by TruffleHog"
      fi
  artifacts:
    paths:
      - secrets-trufflehog.json
  allow_failure: true

# Trivy Secret Scanning
secret:trivy:
  extends: .secret_base
  image: aquasec/trivy:latest
  script:
    - echo "ğŸ” Scanning for secrets with Trivy..."
    - |
      trivy fs \
        --scanners secret \
        --format json \
        --output secrets-trivy.json \
        . || true
    - echo "âœ… Trivy secret scan completed"
  artifacts:
    paths:
      - secrets-trivy.json

# Custom Pattern Matching
secret:custom-patterns:
  extends: .secret_base
  image: alpine:latest
  before_script:
    - apk add --no-cache grep ripgrep
  script:
    - echo "ğŸ” Scanning for custom secret patterns..."
    - |
      cat > patterns.txt << 'EOF'
      # API Keys
      api[_-]?key[_-]?=
      apikey[_-]?=
      api[_-]?secret[_-]?=
      
      # Tokens
      token[_-]?=
      auth[_-]?token[_-]?=
      access[_-]?token[_-]?=
      
      # Passwords
      password[_-]?=
      passwd[_-]?=
      pwd[_-]?=
      
      # AWS
      AKIA[0-9A-Z]{16}
      aws[_-]?access[_-]?key
      aws[_-]?secret[_-]?key
      
      # Private Keys
      -----BEGIN.*PRIVATE KEY-----
      
      # Database URLs
      postgres://
      mysql://
      mongodb://
      
      # JWT
      eyJ[A-Za-z0-9-_=]+\.eyJ[A-Za-z0-9-_=]+\.
      EOF
    - |
      rg -i -f patterns.txt \
        --json \
        --no-ignore \
        --hidden \
        --glob '!.git' \
        --glob '!node_modules' \
        --glob '!*.lock' \
        . > secrets-custom.json || true
    - |
      if [ -s secrets-custom.json ]; then
        echo "âš ï¸ Custom patterns matched!"
        cat secrets-custom.json
      else
        echo "âœ… No custom patterns matched"
      fi
  artifacts:
    paths:
      - secrets-custom.json
  allow_failure: true

# Aggregate Secret Detection Results
secret:aggregate:
  stage: security
  image: python:3.12-slim
  script:
    - echo "ğŸ“Š Aggregating secret detection results..."
    - |
      python3 << 'EOF'
      import json
      import glob
      from collections import defaultdict
      
      findings = []
      summary = {
          "total": 0,
          "by_scanner": defaultdict(int),
          "by_type": defaultdict(int)
      }
      
      for file in glob.glob("secrets-*.json"):
          scanner = file.replace("secrets-", "").replace(".json", "")
          
          try:
              with open(file, 'r') as f:
                  data = json.load(f)
                  
                  # Parse different formats
                  if isinstance(data, dict):
                      if "results" in data:
                          secrets = data["results"]
                      elif "Results" in data:
                          secrets = data["Results"]
                      else:
                          secrets = [data]
                  elif isinstance(data, list):
                      secrets = data
                  else:
                      continue
                  
                  for secret in secrets:
                      findings.append({
                          "scanner": scanner,
                          "file": secret.get("file", secret.get("File", "unknown")),
                          "line": secret.get("line", secret.get("StartLine", 0)),
                          "type": secret.get("type", secret.get("RuleID", "unknown")),
                          "match": secret.get("match", "")[:100]  # Truncate
                      })
                      summary["by_scanner"][scanner] += 1
                      summary["by_type"][secret.get("type", "unknown")] += 1
                      
          except Exception as e:
              print(f"Error processing {file}: {e}")
      
      summary["total"] = len(findings)
      
      report = {
          "version": "1.0",
          "findings": findings,
          "summary": dict(summary)
      }
      
      with open("secrets-report.json", "w") as f:
          json.dump(report, f, indent=2)
      
      print(f"ğŸ“Š Secret Detection Summary:")
      print(f"   Total findings: {summary['total']}")
      for scanner, count in summary["by_scanner"].items():
          print(f"   {scanner}: {count}")
      
      # Fail if secrets found
      if summary["total"] > 0:
          print(f"\nâŒ CRITICAL: {summary['total']} potential secrets detected!")
          print("   Review findings and remove any exposed credentials")
          exit(1)
      else:
          print("\nâœ… No secrets detected")
      EOF
    - echo "âœ… Secret detection aggregation completed"
  artifacts:
    paths:
      - secrets-report.json
    expire_in: 30 days
  needs:
    - secret:detect-secrets
    - secret:gitleaks
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: false  # Fail pipeline if secrets found

# Pre-commit Hook Generator
secret:generate-hook:
  stage: security
  image: python:3.12-slim
  script:
    - echo "ğŸ”§ Generating pre-commit hook for secret detection..."
    - |
      cat > .git/hooks/pre-commit << 'EOF'
      #!/bin/bash
      # Auto-generated secret detection pre-commit hook
      
      echo "ğŸ” Scanning for secrets before commit..."
      
      if command -v detect-secrets &> /dev/null; then
          detect-secrets scan --baseline .secrets.baseline
          if [ $? -ne 0 ]; then
              echo "âŒ Potential secrets detected! Commit blocked."
              exit 1
          fi
      fi
      
      echo "âœ… No secrets detected"
      EOF
    - chmod +x .git/hooks/pre-commit
    - echo "âœ… Pre-commit hook generated"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: true
