{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h1 class="h4 mb-0">AI Command Console</h1>
                    <p class="mb-0 small">Forge the future. Your direct interface to the system's creative core.</p>
                </div>
                <div class="card-body" id="chat-container" style="height: 65vh; display: flex; flex-direction: column;">
                    <div id="chat-output" style="flex-grow: 1; overflow-y: auto; padding-right: 15px;">
                        <div class="alert alert-info small">
                            <strong>Welcome, Architect.</strong> System online. Awaiting creation protocol...
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light p-3">
                    <div class="input-group">
                        <input type="text" id="prompt-input" class="form-control form-control-lg" placeholder="Enter your creation directive...">
                        <button class="btn btn-primary" id="send-btn" type="button">
                            <i class="fas fa-bolt"></i> Forge
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Adding the console.log for definitive proof
    console.log("âœ… Admin Dashboard Script Loaded & Listeners Attached!");

    const promptInput = document.getElementById('prompt-input');
    const sendBtn = document.getElementById('send-btn');
    const chatOutput = document.getElementById('chat-output');

    function addMessage(content, type = 'system', sources = []) {
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('mb-3');

        if (type === 'user') {
            messageWrapper.innerHTML = `<div class="p-2 bg-light text-dark rounded text-end"><strong>></strong> ${content}</div>`;
        } else if (type === 'ai') {
            const sourcesText = sources.length ? `<div class="text-muted small mt-1">Context from: ${sources.join(', ')}</div>` : '';
            messageWrapper.innerHTML = `
                <div class="p-3 bg-primary bg-opacity-10 text-dark rounded">
                    <pre style="white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; margin: 0;">${content}</pre>
                    ${sourcesText}
                </div>`;
        } else if (type === 'error') {
            messageWrapper.innerHTML = `<div class="alert alert-danger small"><strong>Error:</strong> ${content}</div>`;
        } else {
             messageWrapper.innerHTML = `<div class="alert alert-info small">${content}</div>`;
        }
        
        chatOutput.appendChild(messageWrapper);
        chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    async function handleForge() {
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        addMessage(prompt, 'user');
        promptInput.value = '';
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Forging...';

        try {
            const response = await fetch("{{ url_for('admin.handle_generate_code_from_ui') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
            const result = await response.json();
            if (response.ok && result.status === 'success') {
                addMessage(result.code, 'ai', result.sources);
            } else {
                addMessage(result.message || 'An unknown error occurred.', 'error');
            }
        } catch (error) {
            addMessage(error.toString(), 'error');
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-bolt"></i> Forge';
        }
    }

    sendBtn.addEventListener('click', handleForge);
    promptInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            handleForge();
        }
    });
});
</script>
{% endblock %}