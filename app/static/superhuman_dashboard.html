<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CogniForge | Superhuman Admin</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for runtime JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        dark: '#0f172a',
                        surface: '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .code-block { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- COMPONENTS ---

        const Sidebar = ({ activeTab, setActiveTab }) => {
            const menuItems = [
                { id: 'dashboard', icon: 'ph-squares-four', label: 'Overview' },
                { id: 'chat', icon: 'ph-chat-circle-text', label: 'Neural Chat' },
                { id: 'telemetry', icon: 'ph-chart-line-up', label: 'Telemetry' },
                { id: 'security', icon: 'ph-shield-check', label: 'Security' },
            ];

            return (
                <div className="w-64 h-screen border-r border-slate-800 bg-slate-950/50 flex flex-col p-4">
                    <div className="flex items-center gap-3 mb-8 px-2">
                        <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
                            <i className="ph-bold ph-brain text-white text-lg"></i>
                        </div>
                        <h1 className="font-bold text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">
                            CogniForge
                        </h1>
                    </div>

                    <nav className="flex-1 space-y-1">
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 ${
                                    activeTab === item.id
                                    ? 'bg-blue-600/10 text-blue-400 border border-blue-500/20 shadow-[0_0_15px_rgba(59,130,246,0.1)]'
                                    : 'text-slate-400 hover:text-slate-200 hover:bg-slate-900/50'
                                }`}
                            >
                                <i className={`ph-regular ${item.icon} text-xl`}></i>
                                <span className="font-medium text-sm">{item.label}</span>
                            </button>
                        ))}
                    </nav>

                    <div className="mt-auto pt-4 border-t border-slate-800">
                        <div className="flex items-center gap-3 px-2 py-2">
                            <div className="w-8 h-8 rounded-full bg-slate-800 border border-slate-700"></div>
                            <div>
                                <div className="text-sm font-medium">Admin User</div>
                                <div className="text-xs text-slate-500">Superhuman Access</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, change, icon, color }) => (
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                className="glass-panel rounded-xl p-5"
            >
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <div className="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">{title}</div>
                        <div className="text-2xl font-bold font-mono">{value}</div>
                    </div>
                    <div className={`w-10 h-10 rounded-lg ${color} bg-opacity-10 flex items-center justify-center text-${color.split('-')[1]}-400`}>
                        <i className={`ph-fill ${icon} text-xl`}></i>
                    </div>
                </div>
                <div className="flex items-center gap-2 text-xs">
                    <span className="text-emerald-400 bg-emerald-400/10 px-1.5 py-0.5 rounded font-medium">
                        <i className="ph-bold ph-arrow-up-right mr-1"></i>{change}
                    </span>
                    <span className="text-slate-500">vs last hour</span>
                </div>
            </motion.div>
        );

        const Terminal = () => {
             const [logs, setLogs] = useState([
                { ts: '10:00:01', level: 'INFO', msg: 'Reality Kernel V3 initialized' },
                { ts: '10:00:02', level: 'INFO', msg: 'AI Gateway connected to Neural Mesh' },
                { ts: '10:00:05', level: 'SUCCESS', msg: 'System operational at 99.99% efficiency' },
            ]);

            return (
                <div className="glass-panel rounded-xl p-0 overflow-hidden flex flex-col h-full">
                    <div className="bg-slate-900/50 px-4 py-2 border-b border-slate-800 flex items-center justify-between">
                        <div className="text-xs font-mono text-slate-400">SYS.LOG.STREAM</div>
                        <div className="flex gap-1.5">
                            <div className="w-2.5 h-2.5 rounded-full bg-red-500/20"></div>
                            <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/20"></div>
                            <div className="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
                        </div>
                    </div>
                    <div className="p-4 font-mono text-xs space-y-2 overflow-y-auto max-h-60">
                        {logs.map((log, i) => (
                            <div key={i} className="flex gap-3">
                                <span className="text-slate-500">[{log.ts}]</span>
                                <span className={
                                    log.level === 'INFO' ? 'text-blue-400' :
                                    log.level === 'SUCCESS' ? 'text-emerald-400' : 'text-orange-400'
                                }>{log.level}</span>
                                <span className="text-slate-300">{log.msg}</span>
                            </div>
                        ))}
                        <div className="animate-pulse text-blue-500">_</div>
                    </div>
                </div>
            )
        }

        const NeuralChat = () => {
            const [messages, setMessages] = useState([
                { role: 'assistant', content: 'üß† **OVERMIND CLI MINDGATE** ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿπŸÖŸÑ.\n\nÿ£ŸÜÿß ÿßŸÑŸÖŸèŸÜÿ≥ŸÇ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑÿ£ÿπŸÑŸâ - ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®ŸÜÿ∏ÿßŸÖ ŸàŸÉŸÑÿßÿ° ŸÖÿ™ŸÉÿßŸÖŸÑ:\n‚Ä¢ **Agent Tools**: ŸÇÿ±ÿßÿ°ÿ©/ŸÉÿ™ÿßÿ®ÿ©/ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÉŸàÿØ\n‚Ä¢ **Deep Indexer**: ÿ™ÿ≠ŸÑŸäŸÑ ÿπŸÖŸäŸÇ ŸÖŸÜ ÿ¨ÿ∞Ÿàÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ\n‚Ä¢ **Planning System**: ÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸÖÿπŸÇÿØÿ©\n\nŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü üöÄ' }
            ]);
            const [input, setInput] = useState('');
            const [isStreaming, setIsStreaming] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || isStreaming) return;

                const userMsg = { role: 'user', content: input };
                setMessages(prev => [...prev, userMsg]);
                const currentInput = input;
                setInput('');
                setIsStreaming(true);

                const assistantMsg = { role: 'assistant', content: '' };
                setMessages(prev => [...prev, assistantMsg]);

                try {
                    // Get auth token from localStorage or session
                    const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                    
                    // Real API call to OVERMIND CLI MINDGATE
                    const response = await fetch('/admin/api/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token && { 'Authorization': `Bearer ${token}` })
                        },
                        body: JSON.stringify({ 
                            question: currentInput,
                            conversation_id: null 
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    const content = data?.choices?.[0]?.delta?.content || data?.content || '';
                                    if (content) {
                                        fullContent += content;
                                        setMessages(prev => {
                                            const newMsgs = [...prev];
                                            newMsgs[newMsgs.length - 1] = { 
                                                ...newMsgs[newMsgs.length - 1], 
                                                content: fullContent 
                                            };
                                            return newMsgs;
                                        });
                                    }
                                } catch (e) {
                                    // Skip non-JSON lines
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    // Fallback: Show error message
                    setMessages(prev => {
                        const newMsgs = [...prev];
                        newMsgs[newMsgs.length - 1] = { 
                            ...newMsgs[newMsgs.length - 1], 
                            content: `‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: ${error.message}\n\nÿ™ÿ£ŸÉÿØ ŸÖŸÜ:\n1. ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ\n2. ÿ•ÿπÿØÿßÿØ OPENROUTER_API_KEY\n3. ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿÆÿßÿØŸÖ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠` 
                        };
                        return newMsgs;
                    });
                }

                setIsStreaming(false);
            };

            return (
                <div className="h-full flex flex-col glass-panel rounded-xl overflow-hidden">
                    <div className="p-4 border-b border-slate-800 bg-slate-900/30 flex justify-between items-center">
                        <span className="font-semibold text-sm text-blue-400 flex items-center gap-2">
                            <i className="ph-fill ph-sparkle"></i> Neural Interface
                        </span>
                        <span className="text-xs text-slate-500 bg-slate-800 px-2 py-1 rounded">Model: Cogni-v4-Ultra</span>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] rounded-2xl px-4 py-3 text-sm leading-relaxed ${
                                    m.role === 'user'
                                    ? 'bg-blue-600 text-white rounded-br-none'
                                    : 'bg-slate-800/80 text-slate-200 border border-slate-700/50 rounded-bl-none'
                                }`}>
                                    {m.content}
                                    {m.role === 'assistant' && i === messages.length - 1 && isStreaming && (
                                        <span className="inline-block w-1.5 h-4 bg-blue-400 ml-1 animate-pulse align-middle"></span>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="p-4 border-t border-slate-800 bg-slate-900/30">
                        <div className="relative">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                                placeholder="Enter command or query..."
                                className="w-full bg-slate-950/50 border border-slate-700 rounded-lg pl-4 pr-12 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-500"
                            />
                            <button
                                onClick={sendMessage}
                                disabled={!input.trim() || isStreaming}
                                className="absolute right-2 top-1.5 p-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-500 disabled:opacity-50 disabled:hover:bg-blue-600 transition-colors"
                            >
                                <i className="ph-bold ph-paper-plane-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = () => (
            <div className="grid grid-cols-12 gap-6 h-full p-8 overflow-y-auto">
                {/* Stats Row */}
                <div className="col-span-3">
                    <StatCard title="API Latency" value="24ms" change="-12%" icon="ph-lightning" color="bg-yellow-500" />
                </div>
                <div className="col-span-3">
                    <StatCard title="Throughput" value="12.5k" change="+8.2%" icon="ph-wave-sine" color="bg-blue-500" />
                </div>
                <div className="col-span-3">
                    <StatCard title="Error Rate" value="0.01%" change="-0.05%" icon="ph-shield-check" color="bg-emerald-500" />
                </div>
                <div className="col-span-3">
                    <StatCard title="Active Nodes" value="84" change="+2" icon="ph-hard-drives" color="bg-purple-500" />
                </div>

                {/* Main Content Area */}
                <div className="col-span-8 h-[500px]">
                    <NeuralChat />
                </div>
                <div className="col-span-4 h-[500px]">
                    <Terminal />
                </div>
            </div>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [mounted, setMounted] = useState(false);

            useEffect(() => {
                setMounted(true);
            }, []);

            if (!mounted) return null;

            return (
                <div className="flex h-screen bg-gradient-to-br from-slate-950 via-[#0f172a] to-slate-900 text-slate-200">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <main className="flex-1 relative overflow-hidden">
                        {/* Background Ambient Glow */}
                        <div className="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden">
                            <div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-blue-500/10 rounded-full blur-[120px]"></div>
                            <div className="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-indigo-500/10 rounded-full blur-[120px]"></div>
                        </div>

                        <AnimatePresence mode="wait">
                            <motion.div
                                key={activeTab}
                                initial={{ opacity: 0, x: 10 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -10 }}
                                transition={{ duration: 0.2 }}
                                className="h-full relative z-10"
                            >
                                {activeTab === 'dashboard' && <Dashboard />}
                                {activeTab === 'chat' && (
                                    <div className="p-8 h-full">
                                        <NeuralChat />
                                    </div>
                                )}
                                {activeTab !== 'dashboard' && activeTab !== 'chat' && (
                                    <div className="flex items-center justify-center h-full text-slate-500 flex-col gap-4">
                                        <i className="ph-duotone ph-construction text-6xl"></i>
                                        <div className="text-xl font-medium">Module Under Construction</div>
                                    </div>
                                )}
                            </motion.div>
                        </AnimatePresence>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
