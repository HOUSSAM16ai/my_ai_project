<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CogniForge | Superhuman Admin</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for runtime JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- EventSource Polyfill (just in case) -->
    <script src="https://unpkg.com/event-source-polyfill@1.0.31/src/eventsource.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        dark: '#0f172a',
                        surface: '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .code-block { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- AUTH CONTEXT ---
        const AuthContext = createContext(null);

        const AuthProvider = ({ children }) => {
            const [token, setToken] = useState(localStorage.getItem('admin_token'));
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('admin_user') || 'null'));
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const login = async (email, password) => {
                setLoading(true);
                setError(null);
                try {
                    const res = await fetch('/api/security/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await res.json();

                    if (!res.ok) throw new Error(data.detail || 'Login failed');

                    const { access_token, user: userData } = data.data;

                    localStorage.setItem('admin_token', access_token);
                    localStorage.setItem('admin_user', JSON.stringify(userData));
                    setToken(access_token);
                    setUser(userData);
                    return true;
                } catch (err) {
                    setError(err.message);
                    return false;
                } finally {
                    setLoading(false);
                }
            };

            const logout = () => {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                setToken(null);
                setUser(null);
            };

            return (
                <AuthContext.Provider value={{ token, user, login, logout, loading, error }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        const useAuth = () => useContext(AuthContext);

        // --- COMPONENTS ---

        const LoginScreen = () => {
            const { login, loading, error } = useAuth();
            const [email, setEmail] = useState('admin@cogniforge.com'); // Pre-fill for convenience
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                login(email, password);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-950 relative overflow-hidden">
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute -top-[20%] -left-[10%] w-[70vw] h-[70vw] bg-blue-600/10 rounded-full blur-[100px] animate-pulse-slow"></div>
                        <div className="absolute top-[40%] -right-[10%] w-[50vw] h-[50vw] bg-indigo-600/10 rounded-full blur-[100px] animate-pulse-slow" style={{animationDelay: '1s'}}></div>
                    </div>

                    <motion.div
                        initial={{ opacity: 0, scale: 0.95 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="w-full max-w-md p-8 glass-panel rounded-2xl relative z-10"
                    >
                        <div className="text-center mb-8">
                            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/20">
                                <i className="ph-bold ph-fingerprint text-white text-2xl"></i>
                            </div>
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">System Access</h1>
                            <p className="text-slate-500 text-sm mt-2">Identify yourself to proceed to Reality Kernel</p>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 text-xs flex items-center gap-2">
                                <i className="ph-bold ph-warning-circle"></i> {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wider">Identity Code (Email)</label>
                                <div className="relative">
                                    <i className="ph-bold ph-envelope absolute left-3 top-2.5 text-slate-500"></i>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full bg-slate-900/50 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-slate-600"
                                        placeholder="admin@cogniforge.com"
                                        required
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wider">Access Key (Password)</label>
                                <div className="relative">
                                    <i className="ph-bold ph-lock-key absolute left-3 top-2.5 text-slate-500"></i>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full bg-slate-900/50 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-slate-600"
                                        placeholder="••••••••"
                                        required
                                    />
                                </div>
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 rounded-lg transition-all shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
                            >
                                {loading ? <div className="loader"></div> : <><i className="ph-bold ph-sign-in"></i> Authenticate</>}
                            </button>
                        </form>
                    </motion.div>
                </div>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab }) => {
            const { user, logout } = useAuth();
            const menuItems = [
                { id: 'dashboard', icon: 'ph-squares-four', label: 'Overview' },
                { id: 'chat', icon: 'ph-chat-circle-text', label: 'Neural Chat' },
                { id: 'telemetry', icon: 'ph-chart-line-up', label: 'Telemetry' },
                { id: 'security', icon: 'ph-shield-check', label: 'Security' },
            ];

            return (
                <div className="w-64 h-screen border-r border-slate-800 bg-slate-950/50 flex flex-col p-4">
                    <div className="flex items-center gap-3 mb-8 px-2">
                        <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
                            <i className="ph-bold ph-brain text-white text-lg"></i>
                        </div>
                        <h1 className="font-bold text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">
                            CogniForge
                        </h1>
                    </div>

                    <nav className="flex-1 space-y-1">
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 ${
                                    activeTab === item.id
                                    ? 'bg-blue-600/10 text-blue-400 border border-blue-500/20 shadow-[0_0_15px_rgba(59,130,246,0.1)]'
                                    : 'text-slate-400 hover:text-slate-200 hover:bg-slate-900/50'
                                }`}
                            >
                                <i className={`ph-regular ${item.icon} text-xl`}></i>
                                <span className="font-medium text-sm">{item.label}</span>
                            </button>
                        ))}
                    </nav>

                    <div className="mt-auto pt-4 border-t border-slate-800">
                        <div className="flex items-center gap-3 px-2 py-2 mb-2">
                            <div className="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-xs font-bold text-blue-400">
                                {user?.name?.substring(0,2).toUpperCase() || 'AD'}
                            </div>
                            <div className="overflow-hidden">
                                <div className="text-sm font-medium truncate">{user?.name || 'Admin'}</div>
                                <div className="text-xs text-slate-500 truncate">{user?.email}</div>
                            </div>
                        </div>
                        <button onClick={logout} className="w-full flex items-center gap-2 text-xs text-slate-500 hover:text-red-400 px-2 py-1 transition-colors">
                            <i className="ph-bold ph-sign-out"></i> Disconnect
                        </button>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, change, icon, color }) => (
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                className="glass-panel rounded-xl p-5"
            >
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <div className="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">{title}</div>
                        <div className="text-2xl font-bold font-mono">{value}</div>
                    </div>
                    <div className={`w-10 h-10 rounded-lg ${color} bg-opacity-10 flex items-center justify-center text-${color.split('-')[1]}-400`}>
                        <i className={`ph-fill ${icon} text-xl`}></i>
                    </div>
                </div>
                <div className="flex items-center gap-2 text-xs">
                    <span className="text-emerald-400 bg-emerald-400/10 px-1.5 py-0.5 rounded font-medium">
                        <i className="ph-bold ph-arrow-up-right mr-1"></i>{change}
                    </span>
                    <span className="text-slate-500">vs last hour</span>
                </div>
            </motion.div>
        );

        const NeuralChat = () => {
            const { token } = useAuth();
            const [messages, setMessages] = useState([
                { role: 'assistant', content: 'Reality Kernel V3 Connected. I am ready to execute complex architectural commands.' }
            ]);
            const [input, setInput] = useState('');
            const [isStreaming, setIsStreaming] = useState(false);
            const scrollRef = useRef(null);
            const abortControllerRef = useRef(null);

            useEffect(() => {
                if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || isStreaming) return;

                const userText = input;
                const userMsg = { role: 'user', content: userText };

                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setIsStreaming(true);

                // Placeholder for assistant response
                setMessages(prev => [...prev, { role: 'assistant', content: '' }]);

                abortControllerRef.current = new AbortController();

                try {
                    const response = await fetch('/admin/api/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ question: userText }),
                        signal: abortControllerRef.current.signal
                    });

                    if (!response.ok) throw new Error("Network response was not ok");

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.replace('data: ', '').trim();
                                    if (jsonStr === '[DONE]') continue;

                                    const data = JSON.parse(jsonStr);

                                    // Handle OpenAI/OpenRouter style chunks or internal format
                                    let contentPart = '';
                                    if (data.choices && data.choices[0]?.delta?.content) {
                                        contentPart = data.choices[0].delta.content;
                                    } else if (data.content) {
                                        contentPart = data.content;
                                    }

                                    if (contentPart) {
                                        assistantContent += contentPart;
                                        setMessages(prev => {
                                            const newMsgs = [...prev];
                                            const lastMsg = newMsgs[newMsgs.length - 1];
                                            if (lastMsg.role === 'assistant') {
                                                lastMsg.content = assistantContent;
                                            }
                                            return newMsgs;
                                        });
                                    }
                                } catch (e) {
                                    console.warn("Stream parse error:", e);
                                }
                            }
                        }
                    }

                } catch (err) {
                    if (err.name !== 'AbortError') {
                        setMessages(prev => [...prev, { role: 'system', content: `Error: ${err.message}` }]);
                    }
                } finally {
                    setIsStreaming(false);
                }
            };

            return (
                <div className="h-full flex flex-col glass-panel rounded-xl overflow-hidden">
                    <div className="p-4 border-b border-slate-800 bg-slate-900/30 flex justify-between items-center">
                        <span className="font-semibold text-sm text-blue-400 flex items-center gap-2">
                            <i className="ph-fill ph-sparkle"></i> Neural Interface (Live)
                        </span>
                        <div className="flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span className="text-xs text-slate-500">Connected</span>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] rounded-2xl px-4 py-3 text-sm leading-relaxed ${
                                    m.role === 'user'
                                    ? 'bg-blue-600 text-white rounded-br-none shadow-lg shadow-blue-900/20'
                                    : m.role === 'system'
                                        ? 'bg-red-500/10 text-red-400 border border-red-500/20'
                                        : 'bg-slate-800/80 text-slate-200 border border-slate-700/50 rounded-bl-none shadow-lg'
                                }`}>
                                    <div className="whitespace-pre-wrap">{m.content}</div>
                                    {m.role === 'assistant' && i === messages.length - 1 && isStreaming && (
                                        <span className="inline-block w-1.5 h-4 bg-blue-400 ml-1 animate-pulse align-middle"></span>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="p-4 border-t border-slate-800 bg-slate-900/30">
                        <div className="relative">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && sendMessage()}
                                placeholder="Command the AI..."
                                className="w-full bg-slate-950/50 border border-slate-700 rounded-lg pl-4 pr-12 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-500 font-mono"
                            />
                            <button
                                onClick={sendMessage}
                                disabled={!input.trim() || isStreaming}
                                className="absolute right-2 top-1.5 p-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-500 disabled:opacity-50 disabled:hover:bg-blue-600 transition-colors"
                            >
                                <i className="ph-bold ph-paper-plane-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Terminal = () => {
             const [logs, setLogs] = useState([]);

             useEffect(() => {
                const interval = setInterval(() => {
                    const newLog = {
                        ts: new Date().toISOString().split('T')[1].split('.')[0],
                        level: Math.random() > 0.9 ? 'WARN' : 'INFO',
                        msg: `Process PID-${Math.floor(Math.random()*9000)+1000} verified`
                    };
                    setLogs(prev => [...prev.slice(-19), newLog]);
                }, 2000);
                return () => clearInterval(interval);
             }, []);

            return (
                <div className="glass-panel rounded-xl p-0 overflow-hidden flex flex-col h-full">
                    <div className="bg-slate-900/50 px-4 py-2 border-b border-slate-800 flex items-center justify-between">
                        <div className="text-xs font-mono text-slate-400">SYS.LOG.STREAM</div>
                        <div className="flex gap-1.5">
                            <div className="w-2.5 h-2.5 rounded-full bg-red-500/20"></div>
                            <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/20"></div>
                            <div className="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
                        </div>
                    </div>
                    <div className="p-4 font-mono text-xs space-y-2 overflow-y-auto flex-1">
                        {logs.map((log, i) => (
                            <div key={i} className="flex gap-3">
                                <span className="text-slate-500">[{log.ts}]</span>
                                <span className={
                                    log.level === 'INFO' ? 'text-blue-400' : 'text-orange-400'
                                }>{log.level}</span>
                                <span className="text-slate-300">{log.msg}</span>
                            </div>
                        ))}
                        <div className="animate-pulse text-blue-500">_</div>
                    </div>
                </div>
            )
        }

        const Dashboard = () => (
            <div className="grid grid-cols-12 gap-6 h-full p-8 overflow-y-auto">
                {/* Stats Row */}
                <div className="col-span-3">
                    <StatCard title="API Latency" value="24ms" change="-12%" icon="ph-lightning" color="bg-yellow-500" />
                </div>
                <div className="col-span-3">
                    <StatCard title="Throughput" value="12.5k" change="+8.2%" icon="ph-wave-sine" color="bg-blue-500" />
                </div>
                <div className="col-span-3">
                    <StatCard title="Error Rate" value="0.01%" change="-0.05%" icon="ph-shield-check" color="bg-emerald-500" />
                </div>
                <div className="col-span-3">
                    <StatCard title="Active Nodes" value="84" change="+2" icon="ph-hard-drives" color="bg-purple-500" />
                </div>

                {/* Main Content Area */}
                <div className="col-span-8 h-[500px]">
                    <NeuralChat />
                </div>
                <div className="col-span-4 h-[500px]">
                    <Terminal />
                </div>
            </div>
        );

        const MainApp = () => {
            const { user } = useAuth();
            const [activeTab, setActiveTab] = useState('dashboard');

            if (!user) return <LoginScreen />;

            return (
                <div className="flex h-screen bg-gradient-to-br from-slate-950 via-[#0f172a] to-slate-900 text-slate-200">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <main className="flex-1 relative overflow-hidden">
                        {/* Background Ambient Glow */}
                        <div className="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden">
                            <div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-blue-500/10 rounded-full blur-[120px]"></div>
                            <div className="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-indigo-500/10 rounded-full blur-[120px]"></div>
                        </div>

                        <AnimatePresence mode="wait">
                            <motion.div
                                key={activeTab}
                                initial={{ opacity: 0, x: 10 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -10 }}
                                transition={{ duration: 0.2 }}
                                className="h-full relative z-10"
                            >
                                {activeTab === 'dashboard' && <Dashboard />}
                                {activeTab === 'chat' && (
                                    <div className="p-8 h-full">
                                        <NeuralChat />
                                    </div>
                                )}
                                {activeTab !== 'dashboard' && activeTab !== 'chat' && (
                                    <div className="flex items-center justify-center h-full text-slate-500 flex-col gap-4">
                                        <i className="ph-duotone ph-construction text-6xl"></i>
                                        <div className="text-xl font-medium">Module Under Construction</div>
                                    </div>
                                )}
                            </motion.div>
                        </AnimatePresence>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <AuthProvider>
                <MainApp />
            </AuthProvider>
        );
    </script>
</body>
</html>
