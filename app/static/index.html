<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CogniForge • Conversational Cloud</title>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/performance-monitor.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --card: #ffffff;
            --muted: #e2e8f0;
            --text: #0f172a;
            --subtext: #475569;
            --primary: #0f172a;
            --primary-strong: #111827;
            --accent: #2563eb;
            --shadow: 0 18px 36px rgba(15, 23, 42, 0.08);
        }

        * { box-sizing: border-box; }

        body, html {
            height: 100%;
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        a { color: inherit; }

        #root {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar { position: sticky; top: 0; z-index: 10; background: rgba(255,255,255,0.96); backdrop-filter: blur(10px); border-bottom: 1px solid var(--muted); }

        .topbar-inner { max-width: 1180px; margin: 0 auto; padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; gap: 16px; }

        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 18px; letter-spacing: -0.02em; color: var(--text); }

        .brand-icon { width: 34px; height: 34px; display: grid; place-items: center; border-radius: 10px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; box-shadow: 0 8px 24px rgba(37, 99, 235, 0.16); }

        .topbar-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ghost-btn, .solid-btn { padding: 10px 16px; border-radius: 10px; border: 1px solid transparent; font-weight: 700; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease; }

        .ghost-btn {
            background: #fff;
            border-color: var(--muted);
            color: var(--text);
        }

        .ghost-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }

        .solid-btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            box-shadow: 0 12px 30px rgba(37, 99, 235, 0.25);
            border: none;
        }

        .solid-btn:hover { transform: translateY(-1px); box-shadow: 0 14px 40px rgba(14, 165, 233, 0.35); }

        .page-shell { flex: 1; display: flex; flex-direction: column; }

        .hero { max-width: 880px; margin: 40px auto 30px; padding: 10px 20px 0; display: grid; gap: 16px; align-items: center; }

        .hero-card { background: #fff; border-radius: 18px; padding: 28px; box-shadow: 0 16px 40px rgba(15, 23, 42, 0.06); border: 1px solid #e2e8f0; }

        .hero h1 { font-size: 32px; margin: 0 0 12px; letter-spacing: -0.02em; text-align: center; }

        .hero p { margin: 0 0 18px; color: var(--subtext); line-height: 1.6; text-align: center; }

        .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: #e0f2fe; color: var(--primary-strong); font-weight: 700; font-size: 13px; }

        .chat-preview { border: 1px solid var(--muted); border-radius: 18px; background: #f8fafc; padding: 20px; display: flex; flex-direction: column; gap: 12px; }

        .chat-preview .preview-input { background: #fff; border: 1px solid var(--muted); border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; color: var(--subtext); }

        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-top: 16px; }

        .feature { background: #fff; border: 1px solid var(--muted); border-radius: 14px; padding: 14px; font-weight: 700; color: var(--subtext); }

        .welcome-shell { min-height: calc(100vh - 120px); display: grid; place-items: center; padding: 40px 16px 24px; }

        .welcome-card { width: min(880px, 100%); margin: 0 auto; background: #fff; border: 1px solid #e2e8f0; border-radius: 18px; padding: 32px 24px; box-shadow: 0 18px 48px rgba(15, 23, 42, 0.06); }

        .welcome-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 16px; }

        .prompt-row { border: 1px solid var(--muted); border-radius: 16px; padding: 12px 14px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; background: #f8fafc; }

        .prompt-row input { border: none; outline: none; background: transparent; font-size: 16px; padding: 10px; color: var(--text); }

        .quick-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; justify-content: center; }

        .chip { border: 1px solid var(--muted); border-radius: 12px; padding: 8px 12px; background: #fff; display: inline-flex; align-items: center; gap: 6px; font-weight: 700; color: var(--subtext); cursor: pointer; }

        .chip:hover { box-shadow: var(--shadow); transform: translateY(-1px); transition: all 0.15s ease; }

        .workspace {
            flex: 1;
            max-width: 1200px;
            margin: 20px auto 40px;
            width: 100%;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            padding: 0 20px;
        }

        .panel { background: var(--card); border-radius: 16px; border: 1px solid var(--muted); box-shadow: var(--shadow); }

        .panel-header { padding: 18px; border-bottom: 1px solid var(--muted); display: flex; justify-content: space-between; align-items: center; gap: 10px; }

        .panel-title { font-size: 16px; font-weight: 800; margin: 0; display: flex; gap: 8px; align-items: center; }

        .pill-badge { padding: 6px 10px; border-radius: 999px; background: #e0e7ff; color: #4338ca; font-weight: 700; font-size: 12px; }

        .conversation-list { list-style: none; margin: 0; padding: 10px; display: flex; flex-direction: column; gap: 8px; max-height: calc(100vh - 240px); overflow-y: auto; }

        .conversation-item { padding: 12px; border-radius: 12px; border: 1px solid var(--muted); background: #f8fafc; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.15s ease, box-shadow 0.15s ease; }

        .conversation-item.active { border-color: var(--primary); background: #eef2ff; box-shadow: 0 12px 30px rgba(37, 99, 235, 0.15); transform: translateY(-1px); }

        .conversation-item:hover { transform: translateY(-1px); box-shadow: var(--shadow); }

        .chat-panel { display: flex; flex-direction: column; height: calc(100vh - 200px); }

        .messages { flex: 1; padding: 18px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: linear-gradient(180deg, #f8fafc, #fff); }

        .message { display: flex; }

        .message .bubble { padding: 14px 16px; border-radius: 14px; border: 1px solid var(--muted); max-width: 720px; box-shadow: var(--shadow); }

        .message.user { justify-content: flex-end; }

        .message.user .bubble { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; border-color: transparent; }

        .message.assistant .bubble { background: #fff; }

        .input-area { padding: 16px; border-top: 1px solid var(--muted); display: flex; gap: 10px; }

        .input-area textarea { flex: 1; border-radius: 14px; border: 1px solid var(--muted); padding: 12px; resize: none; min-height: 52px; font-size: 15px; font-family: inherit; }

        .input-area button { border: none; border-radius: 12px; padding: 0 18px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; font-weight: 800; cursor: pointer; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.25); }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--subtext); }

        .empty-icon { width: 60px; height: 60px; border-radius: 16px; background: #e0f2fe; display: grid; place-items: center; color: var(--primary); margin: 0 auto 12px; }

        .auth-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.35); display: grid; place-items: center; z-index: 30; padding: 14px; }

        .auth-card { width: min(420px, 100%); background: var(--card); border-radius: 18px; padding: 24px; box-shadow: 0 24px 60px rgba(15, 23, 42, 0.18); border: 1px solid var(--muted); }

        .auth-card h2 { margin: 0 0 6px; }

        .auth-subtitle { margin: 0 0 18px; color: var(--subtext); }

        .input-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }

        .input-group label { font-weight: 700; font-size: 13px; color: var(--subtext); }

        .input-group input { border-radius: 10px; border: 1px solid var(--muted); padding: 12px; font-size: 14px; }

        .modal-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; }

        .link-btn { background: none; border: none; color: var(--primary); font-weight: 700; cursor: pointer; }

        .status { margin: 10px 0; font-weight: 700; }

        .status.error { color: #dc2626; }

        .status.success { color: #16a34a; }

        @media (max-width: 960px) {
            .hero { grid-template-columns: 1fr; padding: 10px; }
            .workspace { grid-template-columns: 1fr; }
            .chat-panel { height: auto; min-height: 60vh; }
            .conversation-list { max-height: 260px; }
            .welcome-card { padding: 24px 18px; }
            .prompt-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useEffect, useMemo, useState, useRef, useCallback, memo } = React;

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            event.preventDefault();
        });

        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error);
            event.preventDefault();
        });

        const IS_CODESPACES = window.location.hostname.includes('github.dev') ||
                             window.location.hostname.includes('app.github.dev') ||
                             window.location.hostname.includes('preview.app.github.dev');

        const IS_CLOUD_ENV = IS_CODESPACES ||
                            window.location.hostname.includes('gitpod.io') ||
                            window.location.hostname.includes('repl.it');

        const showdownConverter = new showdown.Converter({
            simplifiedAutoLink: true,
            excludeTrailingPunctuationFromURLs: true,
            strikethrough: true,
            tables: true,
            tasklists: true,
            simpleLineBreaks: true,
            openLinksInNewWindow: true
        });

        const MAX_MESSAGES = IS_CLOUD_ENV ? 10 : 15;
        const STREAM_UPDATE_THROTTLE = IS_CLOUD_ENV ? 400 : 300;
        const STREAM_MICRO_DELAY = IS_CLOUD_ENV ? 12 : 8;

        const Markdown = memo(({ content }) => {
            const htmlContent = useMemo(() => showdownConverter.makeHtml(content || ''), [content]);
            return <div className="markdown-content" dangerouslySetInnerHTML={{ __html: htmlContent }} />;
        });

        const generateId = () => `${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;

        const TopBar = ({ user, onLoginClick, onRegisterClick, onLogout }) => {
            return (
                <header className="topbar">
                    <div className="topbar-inner">
                        <div className="brand">
                            <div className="brand-icon"><i className="fas fa-infinity"></i></div>
                            Overmind Conversational Cloud
                        </div>
                        <div className="topbar-actions">
                            {user ? (
                                <>
                                    <span style={{ color: '#475569', fontWeight: 700 }}>
                                        {user.name}
                                        {user.is_ephemeral ? ' • جلسة فورية' : ''}
                                    </span>
                                    <button className="ghost-btn" onClick={onLoginClick}>
                                        <i className="fas fa-key"></i> استرجاع محفوظاتي
                                    </button>
                                    {user.is_ephemeral && (
                                        <button className="solid-btn" onClick={onRegisterClick}>ترقية الحساب</button>
                                    )}
                                    <button className="ghost-btn" onClick={onLogout}><i className="fas fa-sign-out-alt"></i> خروج</button>
                                </>
                            ) : (
                                <>
                                    <button className="ghost-btn" onClick={onLoginClick}><i className="fas fa-key"></i> تسجيل الدخول</button>
                                    <button className="solid-btn" onClick={onRegisterClick}>تسجيل سريع</button>
                                </>
                            )}
                        </div>
                    </div>
                </header>
            );
        };

        const Landing = ({ onLoginClick, onRegisterClick, onStartChat }) => {
            const [prompt, setPrompt] = useState('');

            const applyPreset = (text) => setPrompt(text);

            const submitPrompt = () => {
                onStartChat(prompt.trim());
            };

            return (
                <div className="welcome-shell">
                    <div className="welcome-card">
                        <div className="hero">
                            <div className="pill"><i className="fas fa-shield-check"></i> Overmind • API first</div>
                            <h1>بماذا تعمل حالياً؟</h1>
                            <p>
                                واجهة بيضاء تماماً تشبه الصفحة الأولى في المنصات العالمية: يمكنك البدء بالدردشة فوراً كزائر خفيف،
                                ثم الترقية إلى حساب أو تسجيل الدخول من الشريط العلوي عندما ترغب.
                            </p>
                        </div>
                        <div className="prompt-row">
                            <input
                                value={prompt}
                                onChange={(e) => setPrompt(e.target.value)}
                                placeholder="اطرح فكرة أو مهمة لتبدأ المحادثة فوراً"
                            />
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button className="ghost-btn" onClick={submitPrompt}><i className="fas fa-bolt"></i> جرب الآن</button>
                                <button className="solid-btn" onClick={() => onStartChat(prompt.trim())}><i className="fas fa-paper-plane"></i> إرسال</button>
                            </div>
                        </div>
                        <div className="quick-actions">
                            {[
                                { icon: 'fa-paperclip', label: 'Attach', text: 'ارفق ملفاً واطلب تحليله فوراً.' },
                                { icon: 'fa-magnifying-glass', label: 'Search', text: 'ابحث عن أفضل المصادر في لحظات.' },
                                { icon: 'fa-graduation-cap', label: 'Study', text: 'فسّر لي هذا المفهوم بخطوات واضحة.' },
                                { icon: 'fa-image', label: 'Create image', text: 'صمم لي صورة أولية لفكرة المنتج.' },
                                { icon: 'fa-microphone-lines', label: 'Voice', text: 'حوّل هذه الملاحظة الصوتية إلى نقاط عمل.' }
                            ].map((action) => (
                                <button key={action.label} className="chip" onClick={() => applyPreset(action.text)}>
                                    <i className={`fas ${action.icon}`}></i> {action.label}
                                </button>
                            ))}
                        </div>
                        <div className="welcome-actions">
                            <button className="ghost-btn" onClick={onLoginClick}><i className="fas fa-key"></i> تسجيل الدخول</button>
                            <button className="ghost-btn" onClick={onRegisterClick}>إنشاء حساب سريع</button>
                            <button className="solid-btn" onClick={submitPrompt}>ابدأ جلسة تجريبية</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthModal = ({ mode, onClose, onLoginSuccess, onSwitch }) => {
            const [fullName, setFullName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [status, setStatus] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleLogin = async () => {
                setStatus('');
                setIsSubmitting(true);
                try {
                    const response = await fetch('/api/security/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.detail || 'فشل تسجيل الدخول');
                    }

                    const data = await response.json();
                    onLoginSuccess(data.access_token, data.user);
                } catch (error) {
                    setStatus(error.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleRegister = async () => {
                setStatus('');
                setIsSubmitting(true);
                try {
                    const response = await fetch('/api/security/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ full_name: fullName, email, password })
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.detail || 'تعذر إنشاء الحساب');
                    }

                    // بعد نجاح التسجيل، سجل الدخول تلقائياً لضمان إنشاء الجلسة والحفظ الفوري.
                    await handleLogin();
                } catch (error) {
                    setStatus(error.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const submit = async (event) => {
                event.preventDefault();
                if (mode === 'login') {
                    await handleLogin();
                } else {
                    await handleRegister();
                }
            };

            return (
                <div className="auth-backdrop" role="dialog" aria-modal="true">
                    <div className="auth-card">
                        <h2>{mode === 'login' ? 'تسجيل الدخول' : 'إنشاء حساب جديد'}</h2>
                        <p className="auth-subtitle">الواجهة بيضاء وبسيطة؛ المعالجة كلها عبر الـ API.</p>
                        <form onSubmit={submit}>
                            {mode === 'register' && (
                                <div className="input-group">
                                    <label>الاسم الكامل</label>
                                    <input value={fullName} onChange={(e) => setFullName(e.target.value)} required />
                                </div>
                            )}
                            <div className="input-group">
                                <label>البريد الإلكتروني</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            </div>
                            <div className="input-group">
                                <label>كلمة المرور</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                            </div>
                            {status && <div className={`status ${status.toLowerCase().includes('نجاح') ? 'success' : 'error'}`}>{status}</div>}
                            <div className="modal-actions">
                                <button type="button" className="ghost-btn" onClick={onClose}>إغلاق</button>
                                <button type="submit" className="solid-btn" disabled={isSubmitting}>
                                    {isSubmitting ? '...جار التنفيذ' : mode === 'login' ? 'تسجيل الدخول' : 'تسجيل'}
                                </button>
                            </div>
                        </form>
                        <div style={{ marginTop: '10px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <button className="link-btn" onClick={() => onSwitch(mode === 'login' ? 'register' : 'login')}>
                                {mode === 'login' ? 'إنشاء حساب جديد' : 'لديك حساب؟ تسجيل الدخول'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ConversationWorkspace = ({ user, token, onLogout, onRegisterClick, onRequireLogin = () => {}, onRecoverSession = async () => null, initialPrompt = '', onInitialPromptHandled = () => {} }) => {
            const [messages, setMessages] = useState([]);
            const [conversations, setConversations] = useState([]);
            const [conversationId, setConversationId] = useState(null);
            const [input, setInput] = useState('');
            const [isLoadingConversation, setIsLoadingConversation] = useState(false);
            const messagesEndRef = useRef(null);
            const abortControllerRef = useRef(null);
            const initialPromptHandled = useRef(false);

            const safeSetMessages = useCallback((updater) => {
                setMessages((prev) => {
                    const next = typeof updater === 'function' ? updater(prev) : updater;
                    if (next.length > MAX_MESSAGES) {
                        return next.slice(next.length - MAX_MESSAGES);
                    }
                    return next;
                });
            }, []);

            const authHeaders = useMemo(() => ({ 'Authorization': `Bearer ${token}` }), [token]);

            const fetchConversations = useCallback(async () => {
                try {
                    const res = await fetch('/admin/api/conversations', { headers: authHeaders });
                    if (res.ok) {
                        const data = await res.json();
                        setConversations(data);
                    }
                } catch (error) {
                    console.error('Failed to fetch conversations', error);
                }
            }, [authHeaders]);

            const loadConversation = useCallback(async (id) => {
                if (!id) return;
                setConversationId(id);
                setIsLoadingConversation(true);
                setMessages([]);
                try {
                    const res = await fetch(`/admin/api/conversations/${id}`, { headers: authHeaders });
                    if (res.ok) {
                        const data = await res.json();
                        safeSetMessages(data.messages || []);
                        setConversationId(data.conversation_id);
                    } else {
                        const errorData = await res.json().catch(() => ({}));
                        const errorMessage = errorData.detail || 'تعذر تحميل المحادثة';
                        safeSetMessages([{ id: generateId(), role: 'assistant', content: `خطأ: ${errorMessage}` }]);
                    }
                } catch (error) {
                    safeSetMessages([{ id: generateId(), role: 'assistant', content: 'تعذر الوصول للمحادثة. حاول مجدداً.' }]);
                } finally {
                    setIsLoadingConversation(false);
                }
            }, [authHeaders, safeSetMessages]);

            useEffect(() => {
                fetchConversations();
                const fetchLatest = async () => {
                    try {
                        const res = await fetch('/admin/api/chat/latest', { headers: authHeaders });
                        if (res.ok) {
                            const data = await res.json();
                            if (data?.messages) {
                                safeSetMessages(data.messages);
                            }
                            if (data?.conversation_id) {
                                setConversationId(data.conversation_id);
                            }
                        }
                    } catch (error) {
                        console.error('Failed to fetch latest conversation', error);
                    }
                };
                fetchLatest();
            }, [authHeaders, fetchConversations, safeSetMessages]);

            const scrollToBottom = useCallback(() => {
                if (messagesEndRef.current) {
                    requestAnimationFrame(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }));
                }
            }, []);

            useEffect(() => { scrollToBottom(); }, [messages.length, scrollToBottom]);

            const handleNewChat = () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }
                setMessages([]);
                setConversationId(null);
            };

            const handleSend = async (presetInput) => {
                const pendingInput = (presetInput ?? input).trim();
                if (!pendingInput) return;

                let activeToken = token;
                if (!activeToken) {
                    const recoveredToken = await onRecoverSession();
                    if (!recoveredToken) {
                        safeSetMessages(prev => [...prev, { id: generateId(), role: 'assistant', content: 'يرجى تسجيل الدخول أو إنشاء حساب لمتابعة المحادثة.' }]);
                        onRequireLogin();
                        return;
                    }
                    activeToken = recoveredToken;
                }

                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }

                abortControllerRef.current = new AbortController();
                const userMsgId = generateId();
                safeSetMessages(prev => [...prev, { id: userMsgId, role: 'user', content: pendingInput }]);
                setInput('');

                try {
                    const payload = { question: pendingInput };
                    if (conversationId) {
                        payload.conversation_id = String(conversationId);
                    }

                    const response = await fetch('/admin/api/chat/stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${activeToken}` },
                        body: JSON.stringify(payload),
                        signal: abortControllerRef.current.signal
                    });

                    if (response.status === 401) {
                        safeSetMessages(prev => [...prev, { id: generateId(), role: 'assistant', content: 'انتهت صلاحية الجلسة. أعِد تسجيل الدخول لاسترجاع محادثاتك المحفوظة.' }]);
                        onRequireLogin();
                        return;
                    }

                    if (response.status === 403) {
                        const detail = await response.json().catch(() => ({}));
                        const reason = (detail && (detail.detail || detail.message || detail.error || detail)) || 'تعذر إرسال الرسالة الحالية.';
                        safeSetMessages(prev => [...prev, { id: generateId(), role: 'assistant', content: `تم رفض الرسالة: ${reason}` }]);
                        return;
                    }

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Unknown error');
                        throw new Error(`Server error: ${response.status} - ${errorText}`);
                    }

                    if (!response.body) {
                        throw new Error('Response body is not available for streaming');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantMessage = '';
                    let isNewMessage = true;
                    let lastUpdateTime = Date.now();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const text = decoder.decode(value, { stream: true });
                        const segments = text.split('\n\n').filter(Boolean);

                        for (const segment of segments) {
                            if (segment.startsWith('data:')) {
                                const payload = segment.replace('data:', '').trim();
                                if (payload === '[DONE]') {
                                    continue;
                                }
                                try {
                                    const parsed = JSON.parse(payload);
                                    if (parsed.answer_chunk) {
                                        assistantMessage += parsed.answer_chunk;
                                        const now = Date.now();
                                        if (now - lastUpdateTime > STREAM_UPDATE_THROTTLE) {
                                            lastUpdateTime = now;
                                            if (isNewMessage) {
                                                const newId = generateId();
                                                safeSetMessages(prev => [...prev, { id: newId, role: 'assistant', content: assistantMessage }]);
                                                isNewMessage = false;
                                            } else {
                                                safeSetMessages(prev => prev.map((m, idx, arr) => idx === arr.length - 1 ? { ...m, content: assistantMessage } : m));
                                            }
                                        }
                                    }
                                    if (parsed.conversation_id) {
                                        setConversationId(parsed.conversation_id);
                                    }
                                } catch (err) {
                                    console.error('Failed to parse stream chunk', err);
                                }
                            }
                        }
                        await new Promise(resolve => setTimeout(resolve, STREAM_MICRO_DELAY));
                    }

                    if (assistantMessage) {
                        if (isNewMessage) {
                            safeSetMessages(prev => [...prev, { id: generateId(), role: 'assistant', content: assistantMessage }]);
                        } else {
                            safeSetMessages(prev => prev.map((m, idx, arr) => idx === arr.length - 1 ? { ...m, content: assistantMessage } : m));
                        }
                    }

                    await fetchConversations();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.warn('Stream aborted by user');
                        return;
                    }
                    console.error('Streaming Error:', error);
                    safeSetMessages(prev => [...prev, { id: generateId(), role: 'assistant', content: 'حدث خطأ غير متوقع. حاول مرة أخرى.' }]);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            };

            useEffect(() => {
                if (initialPrompt && !initialPromptHandled.current) {
                    initialPromptHandled.current = true;
                    handleSend(initialPrompt);
                    onInitialPromptHandled();
                } else if (!initialPrompt) {
                    initialPromptHandled.current = false;
                }
            }, [handleSend, initialPrompt, onInitialPromptHandled]);

            useEffect(() => () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }
            }, []);

            return (
                <section className="workspace">
                    {user.is_ephemeral && (
                        <div className="panel" style={{ gridColumn: '1 / -1', padding: '14px 18px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '12px' }}>
                            <div style={{ color: '#334155', fontWeight: 700 }}>
                                تجربة فورية جاهزة للعمل — تم إنشاء جلسة دردشة بيضاء مثل واتساب الخفيف مع حفظ تاريخك مباشرة في قاعدة البيانات.
                            </div>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button className="ghost-btn" onClick={onRegisterClick}>إنشاء حساب دائم</button>
                                <button className="solid-btn" onClick={onLogout}>إعادة بدء جلسة جديدة</button>
                            </div>
                        </div>
                    )}
                    <div className="panel">
                        <div className="panel-header">
                            <h3 className="panel-title"><i className="fas fa-clock-rotate-left"></i> سجل المحادثات</h3>
                            <button className="ghost-btn" onClick={handleNewChat}><i className="fas fa-plus"></i> جلسة جديدة</button>
                        </div>
                        <ul className="conversation-list">
                            {conversations.map((conv) => {
                                const active = conversationId === conv.conversation_id;
                                return (
                                    <li key={conv.conversation_id} className={`conversation-item ${active ? 'active' : ''}`} onClick={() => loadConversation(conv.conversation_id)}>
                                        <i className={`fas ${active && isLoadingConversation ? 'fa-spinner fa-spin' : 'fa-comment-dots'}`}></i>
                                        <span>{conv.title || `محادثة ${conv.conversation_id}`}</span>
                                    </li>
                                );
                            })}
                            {conversations.length === 0 && (
                                <li className="conversation-item" style={{ cursor: 'default', justifyContent: 'center' }}>
                                    <i className="fas fa-sparkles"></i>
                                    <span>سيتم إنشاء المحادثات تلقائياً بعد أول رسالة.</span>
                                </li>
                            )}
                        </ul>
                    </div>
                    <div className="panel chat-panel">
                        <div className="panel-header">
                            <div>
                                <p className="panel-title" style={{ margin: 0 }}>
                                    <i className="fas fa-wand-magic-sparkles"></i> مساحة الحوار الذكي
                                </p>
                                <small style={{ color: '#475569' }}>كل رسالة تُرسل عبر واجهة API مستقلة وتُحفظ مع رقم الجلسة.</small>
                            </div>
                            <div className="pill-badge">{user.is_ephemeral ? 'جلسة تجريبية' : 'وصول موثوق'}</div>
                        </div>
                        <div className="messages">
                            {isLoadingConversation ? (
                                <div className="empty-state">
                                    <div className="empty-icon"><i className="fas fa-circle-notch fa-spin"></i></div>
                                    <p>جارٍ استعادة سجل الجلسة...</p>
                                </div>
                            ) : messages.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-icon"><i className="fas fa-magic"></i></div>
                                    <p>ابدأ المحادثة الأولى وسيتم إنشاء الحساب والجلسة في قاعدة البيانات تلقائياً.</p>
                                </div>
                            ) : (
                                messages.map((msg) => {
                                    const key = msg.id || generateId();
                                    if (msg.role === 'init') {
                                        return <div key={key} className="empty-state">{msg.content}</div>;
                                    }
                                    return (
                                        <div key={key} className={`message ${msg.role}`}>
                                            <div className="bubble">
                                                <Markdown content={msg.content} />
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="input-area">
                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="اكتب سؤالك هنا..."
                                rows="1"
                            />
                            <button onClick={handleSend}><i className="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </section>
            );
        };

        const App = () => {
            const [token, setToken] = useState(() => {
                return localStorage.getItem('token') || localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
            });
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [authMode, setAuthMode] = useState(null);
            const [isBootstrappingGuest, setIsBootstrappingGuest] = useState(false);
            const [bootstrapError, setBootstrapError] = useState('');
            const [guestCredentials, setGuestCredentials] = useState(() => {
                const cached = sessionStorage.getItem('instant-guest');
                return cached ? JSON.parse(cached) : null;
            });
            const [isEphemeralSession, setIsEphemeralSession] = useState(() => Boolean(sessionStorage.getItem('instant-guest')));
            const [view, setView] = useState('welcome');
            const [initialPrompt, setInitialPrompt] = useState('');

            const syncTokens = (accessToken) => {
                localStorage.setItem('token', accessToken);
                localStorage.setItem('auth_token', accessToken);
                sessionStorage.setItem('auth_token', accessToken);
                setToken(accessToken);
            };

            const handleLoginSuccess = (accessToken, profile, isEphemeral = false) => {
                syncTokens(accessToken);
                if (isEphemeral) {
                    setIsEphemeralSession(true);
                } else {
                    sessionStorage.removeItem('instant-guest');
                    setGuestCredentials(null);
                    setIsEphemeralSession(false);
                }

                setUser({ ...profile, is_ephemeral: isEphemeral });
                setAuthMode(null);

                if (profile?.is_admin) {
                    window.location.href = '/static/superhuman_dashboard.html';
                    return;
                }

                setView('chat');
            };

            const persistGuestCredentials = (identity) => {
                sessionStorage.setItem('instant-guest', JSON.stringify(identity));
                setGuestCredentials(identity);
                setIsEphemeralSession(true);
            };

            const startChatting = (prompt) => {
                setInitialPrompt(prompt || '');
                setView('chat');
            };

            const clearInitialPrompt = () => setInitialPrompt('');

            useEffect(() => {
                if (user && token && view === 'welcome') {
                    setView('chat');
                }
            }, [user, token, view]);

            const loginWithCredentials = async (email, password) => {
                const response = await fetch('/api/security/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'فشل تسجيل الدخول');
                }

                return response.json();
            };

            const registerIdentity = async (identity) => {
                const response = await fetch('/api/security/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: identity.name,
                        email: identity.email,
                        password: identity.password
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'تعذر إنشاء الحساب السريع');
                }
            };

            const createInstantIdentity = () => ({
                name: `زائر لحظي ${Math.floor(Math.random() * 9000) + 1000}`,
                email: `instant-${Date.now()}-${Math.random().toString(36).slice(2, 7)}@guest.local`,
                password: `Guest-${Math.random().toString(36).slice(2, 10)}!A`
            });

            const bootstrapInstantGuest = useCallback(async () => {
                setIsBootstrappingGuest(true);
                setBootstrapError('');

                const identity = guestCredentials || createInstantIdentity();

                try {
                    const loginData = await loginWithCredentials(identity.email, identity.password);
                    handleLoginSuccess(loginData.access_token, loginData.user, true);
                    if (!guestCredentials) {
                        persistGuestCredentials(identity);
                    }
                } catch (loginError) {
                    try {
                        await registerIdentity(identity);
                        persistGuestCredentials(identity);
                        const loginData = await loginWithCredentials(identity.email, identity.password);
                        handleLoginSuccess(loginData.access_token, loginData.user, true);
                    } catch (error) {
                        console.error('Failed to bootstrap instant guest', error);
                        setBootstrapError(error.message || 'تعذر بدء الجلسة الفورية');
                        setToken(null);
                        setUser(null);
                        sessionStorage.removeItem('instant-guest');
                        setGuestCredentials(null);
                        setIsEphemeralSession(false);
                    }
                } finally {
                    setIsLoading(false);
                    setIsBootstrappingGuest(false);
                }
            }, [guestCredentials]);

            const recoverOrLogin = useCallback(async () => {
                try {
                    await bootstrapInstantGuest();
                    const refreshed = localStorage.getItem('token') || localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                    if (refreshed) {
                        setToken(refreshed);
                        return refreshed;
                    }
                } catch (error) {
                    console.error('Recovery failed', error);
                }
                setAuthMode('login');
                return null;
            }, [bootstrapInstantGuest]);

            useEffect(() => {
                const stored = localStorage.getItem('token') || localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                if (!stored) {
                    bootstrapInstantGuest();
                    return;
                }

                const fetchUser = async () => {
                    try {
                        const res = await fetch('/api/security/user/me', { headers: { Authorization: `Bearer ${stored}` } });
                        if (res.ok) {
                            const data = await res.json();
                            handleLoginSuccess(stored, { ...data, is_admin: data.is_admin }, isEphemeralSession);
                        } else {
                            localStorage.removeItem('token');
                            localStorage.removeItem('auth_token');
                            sessionStorage.removeItem('auth_token');
                            setToken(null);
                            setUser(null);
                            setIsEphemeralSession(false);
                            await bootstrapInstantGuest();
                            return;
                        }
                    } catch (error) {
                        console.error('Failed to hydrate session', error);
                        localStorage.removeItem('token');
                        localStorage.removeItem('auth_token');
                        sessionStorage.removeItem('auth_token');
                        setToken(null);
                        setUser(null);
                        setIsEphemeralSession(false);
                        await bootstrapInstantGuest();
                        return;
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchUser();
            }, [bootstrapInstantGuest, isEphemeralSession]);

            const logout = () => {
                localStorage.removeItem('token');
                localStorage.removeItem('auth_token');
                sessionStorage.removeItem('auth_token');
                sessionStorage.removeItem('instant-guest');
                setToken(null);
                setUser(null);
                setAuthMode(null);
                setView('welcome');
                setIsEphemeralSession(false);
                bootstrapInstantGuest();
            };

            const canRenderWorkspace = !!token && !!user;

            if (isLoading || isBootstrappingGuest) {
                return (
                    <div style={{ display: 'grid', placeItems: 'center', minHeight: '100vh', color: '#475569', background: '#fff' }}>
                        <div className="empty-icon"><i className="fas fa-bolt"></i></div>
                        <p>نطلق لك جلسة دردشة فورية بأسلوب واتساب الخفيف.</p>
                    </div>
                );
            }

            return (
                <div className="page-shell">
                    <TopBar
                        user={user}
                        onLoginClick={() => setAuthMode('login')}
                        onRegisterClick={() => setAuthMode('register')}
                        onLogout={logout}
                    />
                    {bootstrapError && (
                        <div className="hero" style={{ marginTop: 10 }}>
                            <div className="hero-card" style={{ gridColumn: '1 / -1', display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '14px' }}>
                                <div>
                                    <h2 style={{ margin: '0 0 6px' }}>تعثرت الجلسة الفورية</h2>
                                    <p style={{ margin: 0, color: '#475569' }}>{bootstrapError}</p>
                                </div>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button className="solid-btn" onClick={bootstrapInstantGuest}>إعادة المحاولة فوراً</button>
                                    <button className="ghost-btn" onClick={() => setAuthMode('register')}>إنشاء حساب يدوي</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {view === 'welcome' || !canRenderWorkspace ? (
                        <Landing
                            onLoginClick={() => setAuthMode('login')}
                            onRegisterClick={() => setAuthMode('register')}
                            onStartChat={startChatting}
                        />
                    ) : (
                        <ConversationWorkspace
                            user={user}
                            token={token}
                            onLogout={logout}
                            onRegisterClick={() => setAuthMode('register')}
                            onRequireLogin={() => setAuthMode('login')}
                            onRecoverSession={recoverOrLogin}
                            initialPrompt={initialPrompt}
                            onInitialPromptHandled={clearInitialPrompt}
                        />
                    )}
                    {authMode && (
                        <AuthModal
                            mode={authMode}
                            onClose={() => setAuthMode(null)}
                            onLoginSuccess={handleLoginSuccess}
                            onSwitch={setAuthMode}
                        />
                    )}
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError() {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('React Error Boundary caught an error:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '40px', textAlign: 'center' }}>
                            <div className="empty-icon"><i className="fas fa-bug"></i></div>
                            <h2>واجهتنا مشكلة في العرض</h2>
                            <p>أعد تحميل الصفحة واستأنف التجربة البيضاء النقية.</p>
                            <button className="solid-btn" onClick={() => window.location.reload()}>إعادة التحميل</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>,
            document.getElementById('root')
        );
    </script>
</body>
</html>
