# مبادئ الهندسة المعمارية لمنصة CogniForge

## نظرة عامة

CogniForge هي منصة ذكاء اصطناعي متقدمة لتوليد الكود التلقائي وتنفيذ المهام بشكل مستقل. تم تصميم النظام ليحول الأهداف المكتوبة باللغة الطبيعية إلى مهام منظمة قابلة للتنفيذ، مما يوفر للمطورين والفرق قدرات متقدمة في توليد الكود وتحليله وإعادة هيكلته.

## الحاويات الثلاث الأساسية

### 1. حاوية قاعدة البيانات (`db`)
- **الصورة**: `supabase/postgres:15.1.0.118`
- **اسم الحاوية**: `cogniforge-db`
- **الغرض**: تخزين البيانات المستمر للمهام والمستخدمين والتكوينات
- **المنافذ**: داخلية فقط (5432)
- **الشبكة**: `appnet`
- **الحجم**: `pgdata` للبيانات المستمرة
- **فحص الصحة**: `pg_isready -U postgres` كل 10 ثوانٍ

**المسؤوليات**:
- تخزين بيانات المهام (Missions) وخططها (Plans)
- إدارة معلومات المستخدمين والمصادقة
- حفظ سجلات الأحداث والتليمتري
- تخزين فهارس الكود العميقة والتحليلات

### 2. حاوية الويب (`web`)
- **الصورة**: مبنية من `Dockerfile` المحلي
- **اسم الحاوية**: `flask-frontend`
- **الغرض**: واجهة الويب الرئيسية وإدارة المهام
- **المنافذ**: `5000:5000`
- **الشبكة**: `appnet`
- **الخادم**: Gunicorn مع Flask
- **الحجم**: `.:/app` للتطوير المباشر

**المسؤوليات**:
- واجهة التحكم في المهام (Mission Control Dashboard)
- معالجة طلبات المستخدمين وإدارة الجلسات
- تنسيق العمليات بين طبقات النظام
- تنفيذ أوامر CLI المتقدمة عبر MindGate

### 3. حاوية خدمة الذكاء الاصطناعي (`ai_service`)
- **الصورة**: مبنية من `./ai_service/Dockerfile`
- **اسم الحاوية**: `fastapi-ai-service`
- **الغرض**: معالجة عمليات الذكاء الاصطناعي المتقدمة
- **المنافذ**: `8001:8000`
- **الشبكة**: `appnet`
- **الخادم**: FastAPI مع Uvicorn
- **الحجم**: `./ai_service:/code` للتطوير

**المسؤوليات**:
- تشغيل نماذج الذكاء الاصطناعي (GPT-4o، Transformers)
- معالجة طلبات توليد الكود والتحليل
- تنفيذ خوارزميات التضمين (Embeddings)
- عزل العمليات كثيفة الموارد

## الهيكل المعماري المتقدم

### طبقة التنسيق الرئيسية (Overmind Orchestration)
- **OvermindService**: المنسق المركزي لدورات حياة المهام الكاملة
- **UltraHyperPlanner**: محرك التخطيط المتقدم مع خط أنابيب توليد دلالي من 10 خطوات
- **Deep Indexer**: نظام تحليل هيكلي عميق للكود مع بناء خرائط الاستدعاءات

### طبقة الذكاء التخطيطي
- **PlannerFactory**: اكتشاف وإدارة واختيار المخططات المثلى
- **Planning Schemas**: هياكل البيانات للمهام والخطط مع التحقق
- **Adaptive Replanning**: إعادة التخطيط التلقائي عند فشل المهام

### طبقة خدمات الذكاء الاصطناعي
- **MaestroGenerationService**: بوابة تنسيق LLM مع تكامل الأدوات
- **Agent Tools**: سجل أدوات موحد لعمليات الملفات والاستدلال المعرفي
- **LLM Client Service**: واجهة مقدمي الذكاء الاصطناعي مع منطق إعادة المحاولة

### طبقة الذكاء النظامي
- **Akasha+ System Service**: إدراك البيئة وإدارة الذاكرة
- **Vector Memory**: تكامل ChromaDB للبحث الدلالي في الكود
- **Structural Intelligence**: تحليل الطبقات وكشف النقاط الساخنة

## تدفق البيانات والعلاقات

### أنماط تدفق البيانات
```
المستخدم → واجهة الويب → OvermindService → PlannerFactory → UltraHyperPlanner
                ↓                    ↓                    ↓
        قاعدة البيانات ← Agent Tools ← MaestroService ← خدمة الذكاء الاصطناعي
```

### آليات الاستمرارية
- **قاعدة البيانات الأساسية**: PostgreSQL عبر Supabase
- **طبقة ORM**: SQLAlchemy مع تجميع الاتصالات
- **التكوينات البيئية**:
  - التطوير: PostgreSQL محلي في Docker
  - الاختبار: SQLite في الذاكرة
  - الإنتاج: PostgreSQL مستمر

### مرونة قاعدة البيانات
- تجميع الاتصالات مع pre-ping للموثوقية
- فحوصات الصحة تضمن جاهزية قاعدة البيانات قبل بدء الخدمة

## التبعيات الداخلية والخارجية

### التبعيات الخارجية الرئيسية
- **إطار الويب**: Flask، Werkzeug، Gunicorn
- **مكدس الذكاء الاصطناعي**: PyTorch (CPU)، Transformers، Sentence-Transformers، OpenAI
- **قاعدة البيانات**: PostgreSQL، psycopg2-binary
- **الخدمات غير المتزامنة**: FastAPI، Uvicorn
- **أدوات CLI**: Typer، Rich، Click
- **المعالجة**: ThreadPoolExecutor، asyncio

### التبعيات الداخلية
- **نماذج المجال**: Mission، MissionPlan، Task، MissionEvent
- **خدمات الأعمال**: master_agent_service، generation_service، system_service
- **أدوات التخطيط**: llm_planner، deep_indexer، factory
- **واجهات CLI**: mindgate_commands، system_commands، user_commands

## الميزات المتقدمة

### نظام التخطيط الذكي
- **التخطيط الدلالي**: فهم عميق لسياق الكود والمتطلبات
- **التخطيط التكيفي**: إعادة التخطيط التلقائي عند الفشل
- **التخطيط المتدفق**: توليد المحتوى على دفعات للملفات الكبيرة
- **L4 Scan Pipeline**: تحليل متقدم متعدد المجلدات مع تصنيف معماري

### نظام الحماية والأمان
- **Guard System**: آلية أمان في OvermindService مع فحوصات مسبقة
- **Dual-Authority Protocol**: نمط أمان في entrypoint.sh
- **Quarantine System**: إدارة المخططات غير الموثوقة
- **Circuit Breaking**: حماية من الفشل المتتالي

### محرك الاستيفاء والذاكرة
- **Interpolation Engine**: نظام قوالب لاستبدال المتغيرات
- **Vector Memory**: ذاكرة دلالية للبحث في الكود
- **Cache System**: تخزين مؤقت تدريجي للفهرسة العميقة

## مقاييس الأداء والتليمتري

### مقاييس النظام
- **معدل نجاح المهام**: نسبة المهام المكتملة بنجاح
- **زمن التخطيط**: متوسط وقت توليد الخطط
- **دقة الفهرسة**: عدد الملفات والنقاط الساخنة المحللة
- **استخدام الذاكرة**: مراقبة استهلاك الموارد

### مقاييس الجودة
- **تعقيد الكود**: تحليل تعقيد الدوال والملفات
- **التكرار**: كشف الكود المكرر والأنماط
- **التبعيات**: خريطة العلاقات بين المكونات
- **النقاط الساخنة**: تحديد المناطق عالية التعقيد

## التكوين والبيئة

### متغيرات البيئة الرئيسية
```bash
# تكوين قاعدة البيانات
DATABASE_URL=postgresql://user:pass@db:5432/dbname
DATABASE_PASSWORD=secure_password

# تكوين الذكاء الاصطناعي
OPENAI_API_KEY=sk-...
PLANNER_STREAMING_ENABLE=1
PLANNER_L4_ENABLED=1

# تكوين الفهرسة العميقة
DEEP_INDEX_MAX_FILES=4000
DEEP_INDEX_THREADS=4
DEEP_INDEX_CALL_GRAPH=1

# تكوين الحماية
OVERMIND_GUARD_ENABLED=1
PLANNER_INDEX_CACHE_ENABLE=1
```

### أوضاع التشغيل
- **وضع التطوير**: Docker Compose مع إعادة التحميل المباشر
- **وضع الإنتاج**: Gunicorn مع عمال متعددين
- **وضع الاختبار**: SQLite في الذاكرة مع بيانات وهمية

## الخلاصة

CogniForge يمثل نظاماً متقدماً للذكاء الاصطناعي التطبيقي في تطوير البرمجيات، يجمع بين التخطيط الذكي والتنفيذ المستقل والفهم العميق للكود. الهيكل المعماري المكون من ثلاث حاويات يوفر الفصل الواضح للمسؤوليات مع التكامل السلس بين المكونات.

النظام مصمم للتطور والتوسع، مع آليات حماية متقدمة وقدرات تكيفية تجعله منصة موثوقة لتطوير البرمجيات بمساعدة الذكاء الاصطناعي.
