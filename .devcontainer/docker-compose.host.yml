# Docker Compose file specifically for DevContainer/Codespaces/Ona
# Modified: Enabled network_mode: host as required for ONA agent connectivity.
# Note: When using host network mode, port mappings are ignored/invalid.

x-common-environment: &common-environment
  # Basic environment variables
  ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
  ADMIN_NAME: ${ADMIN_NAME:-Admin}
  ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
  DATABASE_URL: ${DATABASE_URL:-sqlite+aiosqlite:///./cogniforge.db}
  OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
  SECRET_KEY: ${SECRET_KEY:-development-secret-key-change-in-production}
  ENV: ${ENV:-development}
  PYTHONUNBUFFERED: "1"

services:
  # Backend Service - FastAPI with Uvicorn
  web:
    build:
      context: ..  # Context is relative to this file, so up one level to root
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: "1"
    container_name: cogniforge-backend
    restart: unless-stopped

    # Enabled Host Mode for ONA Agent compatibility
    network_mode: host

    # Ports are not used in host mode
    # ports:
    #   - "8000:8000"

    environment:
      <<: *common-environment
      PORT: 8000

    healthcheck:
      test: ["CMD", "bash", "-c", "curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Sleep infinity - supervisor.sh handles Uvicorn startup
    # This prevents duplicate Uvicorn instances (one from docker-compose, one from supervisor.sh)
    command: ["sleep", "infinity"]

    volumes:
      - ..:/app  # Mount root directory to /app
      - /app/__pycache__

# Networks configuration is irrelevant in host mode but kept for structure if needed later
networks:
  default:
    driver: bridge
