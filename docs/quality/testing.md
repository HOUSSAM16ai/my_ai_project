# Testing & Coverage Standards

> الهدف: اختبارات مفهومة للمبتدئين + تغطية 100% للمسارات الحرجة.

## 1. مبادئ الاختبار

- **الاختبارات مواصفات:** اختبر "ماذا يفعل" النظام وليس "كيف يفعل" ذلك.
- **حتمية وقابلة للتكرار:** لا تعتمد على الزمن الحقيقي أو الشبكة بدون عزل.
- **تسميات واضحة:** أسماء الاختبارات يجب أن تشرح السلوك المتوقع.

## 2. استراتيجية الطبقات

1. **Unit Tests**: تغطي قواعد المجال وملفات use-cases بمخازن وهمية.
2. **Contract Tests**: تتحقق من قابلية الاستبدال (LSP) للواجهات.
3. **API Tests**: تحقق مسارات HTTP الحرجة عبر FastAPI TestClient/AsyncClient.
4. **Integration Smoke**: فحص سريع للهجرات والتهيئة دون تحميل بيئة ثقيلة.

## 3. التغطية (Coverage)

- **الهدف:** 100% على الكود الأساسي (First-party).
- **الأداة:** `coverage.py` عبر `pytest --cov`.
- **الفشل عند الانخفاض:** يتم ضبط `--cov-fail-under=100` للملفات المشمولة.

### 3.1 الاستثناءات المسموح بها

يُسمح بالاستثناءات فقط عند وجود مبرر تقني واضح:

- **الكود المُولّد تلقائيًا.**
- **ملفات الهجرات المُولّدة (Alembic).**
- **شيفرة الطرف الثالث (vendor/).**

يجب توثيق كل استثناء في هذا الملف مع السبب.

## 4. أوامر التشغيل المعيارية

- تشغيل الاختبارات الكاملة:
  ```bash
  make test
  ```
- تشغيل فحوصات CI محليًا:
  ```bash
  make ci
  ```

## 5. جدول استثناءات التغطية

| المسار | السبب | المالك | تاريخ المراجعة |
| :--- | :--- | :--- | :--- |
| migrations/* | كود مولّد تلقائيًا بواسطة Alembic | الفريق | كل ربع سنة |
