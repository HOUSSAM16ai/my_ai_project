# تقرير استكشاف فصل المسارات بين الزبون والأدمن (Overmind Boundary Discovery)

## 1) منهج المصادقة الحالي
- يعتمد النظام على JWT موقّع بمفتاح `SECRET_KEY` عبر `AuthBoundaryService`.
- يتم إنشاء رمز JWT في `AuthBoundaryService.authenticate_user` مع حقول `sub`, `email`, `role`, `is_admin`.
- طبقة التبعيات `deps/auth.py` تستخرج المستخدم والأدوار والامتيازات وتعيد `CurrentUser`.

## 2) تخزين الأدوار
- يوجد حقل `is_admin` على نموذج المستخدم (قاعدة البيانات).
- يوجد نظام RBAC مستقل عبر جداول: `roles`, `user_roles`, `role_permissions`.
- عند تسجيل الدخول، إذا لم تكن هناك أدوار للمستخدم، يتم تعيين دور افتراضي بناءً على `is_admin`.

## 3) نقاط الدخول لمسار الدردشة
- مسار الزبون: `WS /api/chat/ws` عبر `CustomerChatBoundaryService`.
- مسار الأدمن: `WS /admin/api/chat/ws` عبر `AdminChatBoundaryService`.
- كلا المسارين يستخدمان `ChatOrchestrator.process` للبث، لكن يتم حقن رسائل نظام مختلفة.

## 4) مصدر الخلط (Root Cause)
- الاعتماد على فحص `is_admin` داخل بعض المسارات أدى إلى احتمالية تنفيذ مسار غير صحيح.
- اعتماد بعض نقاط الدخول على خدمات منفصلة بدون بوابة تفريع موحدة زاد احتمال الانحراف.
- عدم وجود طبقة تفريع مركزية تسبب في خلط السياسات والأدوات عند تغيير المسارات.

## 5) نقاط التصحيح المطلوبة
- إضافة بوابة تفريع مركزية تعتمد الدور كقرار وحيد.
- عزل مسارات الزبون والأدمن عبر حدود مستقلة.
- منع أي استدعاء لمسار الأدمن من خارج البوابة المركزية.
