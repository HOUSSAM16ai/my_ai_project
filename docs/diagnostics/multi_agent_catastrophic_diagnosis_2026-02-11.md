# التشخيص الخارق لمشكلة الوكلاء المتعددين (الزبون + الأدمن)

## ملخص تنفيذي

هذه المشكلة **ليست عطبًا واحدًا**، بل هي فشل مركّب من ثلاث طبقات تعمل معًا:

1. **طبقة العرض (Frontend UI/UX):** انزياح/قصّ عناصر جانبية في الهاتف (خصوصًا RTL) بسبب تموضع وقصّ الحاويات.
2. **طبقة الحالة الزمنية للوكلاء (Timeline FSM):** تداخل حالة الجولات (Runs/Iterations) داخل نفس المهمة وعدم عزلها بشكل صارم.
3. **طبقة البث النصي (Streaming Narrative):** تضخم وازدواج في السرد المرحلي داخل نفس فقاعة الرد، ما يعطي انطباع “كارثي” حتى عندما التنفيذ الخلفي يسير.

النتيجة الظاهرة في صفحتي الزبون والأدمن: **تجربة مشوهة بصريًا + سلوك مرحلي غير موثوق إدراكيًا + طوفان رسائل حالة**.

---

## نطاق التشخيص

- تشخيص عميق فقط دون تعديل سلوكي أو إصلاحات تنفيذية.
- تم تحليل مسار الزبون ومسار الأدمن كاملًا من الـ WebSocket حتى عرض الـ Timeline والرسائل.

---

## الدليل التقني (Evidence Trail)

### 1) السبب البنيوي لاشتراك العطب بين الزبون والأدمن

المكوّن الرئيسي نفسه يختار فقط endpoint مختلف حسب الدور، لكن **نفس واجهة العرض والـ hooks** تُستخدم للطرفين:

- `endpoint = user.is_admin ? '/admin/api/chat/ws' : '/api/chat/ws'` داخل نفس `DashboardLayout`.
- كلا المسارين يمرّان عبر `useAgentSocket` و `useRealtimeConnection` و `AgentTimeline` و `ChatInterface`.

**الاستنتاج:** أي خلل في هذه الطبقة المشتركة سيضرب الصفحتين معًا بنفس النمط.

---

### 2) عطب بصري مباشر (قصّ/تراكب) في RTL على الهاتف

هناك إشارات واضحة في CSS إلى ارتباك المحاذاة RTL داخل القائمة العلوية:

- `.header-menu` يضبط `left: 0` ثم يعلّق بتعليقات متناقضة حول RTL.
- الحاويات العليا (`.app-container`, `.dashboard-layout`) تستخدم `overflow: hidden`.
- الشريط الجانبي للوكلاء مطلق التموضع (`position: absolute`) مع انتقالات (`transform`) وحدود عالية.

**الأثر المرئي المتوافق مع الصور:**
- القائمة الجانبية/الخط الزمني تظهر مقصوصة جزئيًا ومندفعة فوق المحتوى.
- تداخل طبقات (z-index + absolute + overflow hidden) يجعل جزءًا من النص خارج الإطار المرئي.

---

### 3) خلل عزل الجولات (Run Isolation) في Timeline

في hook الخاص بالـ Timeline:

- `RUN_STARTED` لا يبدّل `activeRunId` إذا كانت هناك قيمة موجودة (`state.activeRunId || runId`).
- الخلفية ترسل `run_id` ثابتًا = `mission_id` حتى مع تكرارات loop.

هذا يعني: **كل iterations داخل نفس المهمة تتراكم في نفس run بصريًا** بدل فصل الجولة الحالية عن السابقة.

**أثر ذلك:**
- حالات قديمة تبقى “مكتملة” بينما مرحلة جديدة تظهر “running” في نفس الوقت بصورة تربك المستخدم.
- الواجهة توحي أن النظام يتراجع/يتذبذب حتى لو المنطق الخلفي صحيح.

---

### 4) تضخم السرد المرحلي داخل فقاعة الرد

تنسيق أحداث الدماغ (`_format_brain_event`) يُنتج نصوصًا احتفالية مطولة لكل حدث:

- لكل `phase_start` جملة طويلة.
- لكل `*_completed` جملة عامة متكررة: “اكتملت مرحلة أساسية بنجاح…”.

وفي نفس الوقت، الـ front يدمج كل `delta` في فقاعة Assistant واحدة حتى `complete`.

**النتيجة:**
- فقاعة واحدة ضخمة مليئة بتكرارات شبه متطابقة.
- المستخدم يقرأ “ضجيج حالة” بدل تقدّم مفهوم.
- هذا يفسر النصوص الطويلة المتكررة الظاهرة في اللقطات.

---

### 5) ازدواجية مسار الأحداث (Canonical + Legacy) تزيد الحساسية

`useAgentTimeline` يدعم معًا:

- Canonical: `RUN_STARTED`, `PHASE_STARTED`, `PHASE_COMPLETED`
- Legacy: `phase_start`, `phase_completed`

الدعم المزدوج مفيد للتوافق، لكنه يرفع احتمال استهلاك حدثين متكافئين لنفس المرحلة إذا وصلتا من طبقات مختلفة في أنظمة هجينة.

حتى مع حراسة `seq`، يبقى النظام حساسًا إذا وُجدت رسائل بلا `seq` أو مصادر متباينة.

---

## تحليل السبب الجذري (Root-Cause Tree)

### الجذر A — Visual Container Contract مكسور على الهاتف
- Absolute side panels + hidden overflow + RTL alignment ambiguity.
- النتيجة: قصّ/إزاحة/تراكب.

### الجذر B — Timeline State Model غير مفصول iteration-wise
- run_id ثابت للمهمة كلها.
- activeRun لا يتجدد عند run start جديد.
- النتيجة: التباس حالة الخطوات.

### الجذر C — Chat Stream Semantics غير مفصولة بين “حالة” و“محتوى نهائي”
- stream يخلط سرد الحالة مع إجابة المستخدم في نفس قناة `delta`.
- النتيجة: تضخم نصي مدمّر للتجربة.

---

## لماذا ظهرت الكارثة في الصفحتين معًا؟

لأن المسارين (admin/customer) يختلفان في endpoint فقط، لكن:

- نفس بنية الـ UI,
- نفس hooks للأحداث,
- نفس أسلوب الدمج النصي,
- ونفس معالج مهمة Overmind.

إذًا العطب **Systemic Shared-Layer Failure** وليس bug خاص بدور واحد.

---

## مؤشر الخطورة

- **الوضوح البصري:** مرتفع (High)
- **موثوقية إدراك التقدم:** مرتفع جدًا (Critical UX)
- **سلامة المنطق الخلفي:** متوسطة (قد يكون المنطق يعمل لكن يُعرض بشكل مضلل)
- **اتساع التأثير:** شامل (Admin + Customer)

---

## الخلاصة التشخيصية النهائية

الوضع الكارثي ناتج عن **انكسار عقدة العرض-الحالة (UI-State Contract)**:

- الخلفية تبث أحداثًا كثيرة (ومنطقياً قد تكون صحيحة)،
- الواجهة لا تعزل الجولات بصريًا كما يجب،
- والنص المرحلي يُدفع بنفس قناة إجابة المستخدم.

فتتكوّن تجربة نهائية “مدمّرة”: واجهة مقصوصة، خطوات متداخلة، ورسائل متكررة طويلة في نفس الفقاعة.

هذا تشخيص سببي كامل بدون أي تعديل تنفيذي.
