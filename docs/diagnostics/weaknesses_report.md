# تقرير تشخيص نقاط الضعف والمشاكل في المشروع (نسخة أولية)

> هذا التقرير يعتمد على مراجعة ملفات الإعداد والاعتمادات وسجلات الاختبارات الموجودة في المستودع.

## 1) مخاطر العزل بين الخدمات المصغّرة (Microservices)
- **مشاركة نفس سياق البناء والشفرة بين الخدمات:** عدة خدمات في `docker-compose.yml` تُبنى من نفس السياق (`context: .`) وتربط نفس مجلد المشروع بداخل الحاويات عبر `volumes`، مما يقلل الاستقلالية ويزيد احتمال الترابط غير المقصود بين الخدمات. هذا يتعارض مع مبدأ استقلالية الخدمة ويجعل أي تغيير في المستودع يؤثر على جميع الخدمات في آن واحد. 【F:docker-compose.yml†L6-L31】【F:docker-compose.yml†L50-L85】
- **قاعدة بيانات SQLite كافتراضي لخدمات مستقلة:** نفس ملف التشغيل يعرّف قواعد بيانات SQLite افتراضية لعدة خدمات، مما يضعف قابلية التوسع والإتاحة العالية للخدمات الإنتاجية. 【F:docker-compose.yml†L65-L69】【F:docker-compose.yml†L130-L132】【F:docker-compose.yml†L160-L162】【F:docker-compose.yml†L190-L192】

## 2) إعدادات إنتاجية غير آمنة أو غير ملائمة
- **وضع الإنتاج مع قاعدة بيانات SQLite ومفتاح سري افتراضي:** في ملف تشغيل الخدمات المصغّرة، تم ضبط `ENVIRONMENT=production` مع `DATABASE_URL=sqlite...` وتوفير `SECRET_KEY` افتراضي قابل للتنبؤ. هذا يفتح الباب لمخاطر أمنية وتدهور الأداء في الإنتاج. 【F:docker-compose.microservices.yml†L14-L18】
- **ملف البيئة يحتوي إعدادات قديمة مرتبطة بـ Flask:** وجود متغيرات مثل `FLASK_APP` و `FLASK_ENV`، بالإضافة إلى تعليق يشير إلى أمر `flask users init-admin`، يوحي بتراكم إعدادات قديمة لا تتوافق مع البنية الحالية المبنية على FastAPI. هذا يسبب التباساً للمطورين ويعقّد الإعدادات. 【F:.env.example†L10-L13】【F:.env.example†L240-L241】

## 3) مشاكل الاعتمادات (Dependencies)
- **اعتمادات غير مثبتة بإصدارات محددة:** وجود حزم بدون تثبيت إصدارات (مثل `pypdf`, `sentence-transformers`, `dspy-ai`, `openai`) يعرّض المشروع لتغييرات مفاجئة في السلوك عند التحديث. 【F:requirements.txt†L64-L78】
- **تكرار الاعتمادات في نفس الملف:** يوجد تكرار لحزم مثل `passlib` و `argon2-cffi`، مما قد يسبب تضارباً أو عدم وضوح في إدارة الإصدارات. 【F:requirements.txt†L20-L23】【F:requirements.txt†L85-L87】

## 4) مشاكل في الاختبارات والاستقرار
- **تحذير إعدادات Pytest:** سجل الاختبارات يشير إلى تجاهل إعدادات pytest من `pyproject.toml`، ما يعني أن جزءاً من الإعدادات لن يُطبق فعلياً. 【F:core_errors.txt†L4】
- **فشل جمع اختبارات بسبب نقص اعتمادات:** السجل يبيّن خطأ `ModuleNotFoundError` لحزمة `llama_index.vector_stores`، مما يكشف أن مسار الاستيراد أو الاعتمادات غير متوافقة مع البيئة الفعلية. 【F:core_errors.txt†L70】【F:core_errors.txt†L96-L97】

## 5) عدم توافق الاستيرادات مع الحزم المثبّتة
- **استيراد `llama_index.vector_stores` في كود الخدمة:** الملف `retriever.py` يستورد `SupabaseVectorStore` من مسار يبدو أنه غير متوفر في بيئة الاختبارات حسب السجلات، وهو ما يؤدي لأعطال مبكرة. 【F:microservices/research_agent/src/search_engine/retriever.py†L1-L5】

## 6) نقاط ضعف في إدارة الحالة والاعتمادية
- **اعتماد على Singletons عالمية:** استخدام متغيرات عالمية كـ `_EMBED_MODEL` و `_RETRIEVER_INSTANCE` قد يسبب تسرباً للحالة أو مشاكل تنافسية في البيئات متعددة الطلبات. 【F:microservices/research_agent/src/search_engine/retriever.py†L9-L18】【F:microservices/research_agent/src/search_engine/retriever.py†L62-L69】

---

# توصيات أولية (مختصرة)
1. **فصل سياقات البناء** لكل خدمة واستخدام مستودعات/حاويات مستقلة قدر الإمكان.
2. **استبدال SQLite** بقاعدة بيانات إنتاجية للخدمات المصغرة مع إدارة أسرار آمنة (Secrets Manager).
3. **تنظيف ملف البيئة** وإزالة إعدادات Flask أو وضعها في ملف قديم منفصل.
4. **تثبيت جميع الحزم بإصدارات محددة** وإزالة التكرار لتحسين التناسق.
5. **مواءمة استيرادات LlamaIndex** مع الحزم المثبتة أو تحديث المسارات.
6. **تقليل الاعتماد على الحالة العالمية** وتبنّي تمرير الحالة بشكل صريح.
