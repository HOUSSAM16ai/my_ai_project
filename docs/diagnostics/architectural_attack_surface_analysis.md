# مقال تحليلي متقدم: تضخيم السطح الهجومي عبر مشاركة سياق البناء وربط المستودع في خدمات متعددة

## الملخص التنفيذي
هذا المقال يشرح بدقة علمية عالية كيف يؤدي **بناء عدة خدمات من نفس سياق المشروع وربط المستودع كاملاً داخل الحاويات** إلى تضخيم السطح الهجومي وزيادة نصف قطر الانفجار. في التشغيل الحالي، تظهر عدة خدمات تبنى من `context: .` وتربط `.:/app` داخل الحاويات، ما يعني أن **النسخة التشغيلية للشفرة واحدة ومشتركة** بين خدمات متعددة بدل أن تكون معزولة لكل خدمة. هذا النمط يحوّل أي اختراق محلي إلى قدرة تأثير منظومي، ويضعف جوهر الاستقلالية التي تقوم عليها الخدمات المصغّرة. تظهر المؤشرات في ملف التشغيل الأساسي عبر خدمات متعددة تستخدم `context: .` وتربط `.:/app` مثل `core-kernel` و`orchestrator-service` و`observability-service` و`planning-agent` و`memory-agent` و`user-service`.【F:docker-compose.yml†L6-L202】

## التعريف العلمي للمشكلة
### 1) السطح الهجومي (Attack Surface)
السطح الهجومي هو مجموع نقاط التعرض التي يمكن استغلالها. عندما تشترك عدة خدمات في **نفس الملفات التشغيلية داخل الحاويات**، يصبح السطح الهجومي موحّداً عملياً. أي ثغرة تتيح الكتابة أو التنفيذ داخل خدمة واحدة قد تتحول إلى قدرة على التلاعب بالمصدر المشترك الذي تعتمد عليه خدمات أخرى.

### 2) نصف قطر الانفجار (Blast Radius)
الهدف من الخدمات المصغّرة هو حصر الضرر داخل “جزيرة خدمة”. لكن ربط المستودع بالكامل يعني أن الأثر لا يتوقف عند حدود الخدمة المخترقة. هنا يصبح “نصف قطر الانفجار” عابراً للخدمات، لأن نفس الشيفرة والملفات يمكن أن تتأثر فوراً في أكثر من مسار تشغيلي.

## دليل معماري مباشر من ملفات التشغيل
### 1) ملف التشغيل الرئيسي (تشغيل متعدد الخدمات)
ملف التشغيل يبيّن بوضوح أن عدة خدمات:
- تُبنى من نفس سياق المشروع (`context: .`).
- تربط المستودع كاملاً داخل الحاوية (`.:/app`).

أمثلة مباشرة:
- `core-kernel` يبني من `context: .` ويربط `.:/app`.【F:docker-compose.yml†L6-L30】
- `orchestrator-service` يبني من `context: .` ويربط `.:/app`.【F:docker-compose.yml†L50-L85】
- `observability-service` يبني من `context: .` ويربط `.:/app`.【F:docker-compose.yml†L87-L112】
- `planning-agent` يبني من `context: .` ويربط `.:/app`.【F:docker-compose.yml†L114-L142】
- `memory-agent` يبني من `context: .` ويربط `.:/app`.【F:docker-compose.yml†L144-L172】
- `user-service` يبني من `context: .` ويربط `.:/app`.【F:docker-compose.yml†L174-L202】

هذه البنية تعني أن الخدمات المختلفة تشترك في نفس النسخة التشغيلية، بدل أن تكون كل خدمة معزولة بكودها وصورتها الخاصة.

### 2) ملف الخدمات المصغّرة المستقل
ملف الخدمات المصغّرة يوضح أيضاً أن كل خدمة تُبنى من نفس السياق (`context: .`) حتى عند تشغيلها بشكل مستقل عن ملف التشغيل الرئيسي، ما يزيد من الاتساق غير المرغوب فيه بين الخدمات عند البناء والنشر.【F:docker-compose.microservices.yml†L7-L151】

## التحليل العميق: لماذا هذا نمط خطير؟
### 1) انهيار حاجز العزل بين الخدمات
العزل ليس مجرد “حاوية منفصلة”. العزل الحقيقي يعني **كود منفصل + نسخة تشغيلية منفصلة + سطح ملفات منفصل**. عند مشاركة نفس المستودع، ينهار هذا الحاجز، ويصبح الاختراق المحلي قابلاً للتمدد.

### 2) انتقال التأثير عبر طبقة الملفات
أي ثغرة تمنح قدرة تعديل ملفات داخل `/app` في خدمة واحدة قد تؤثر مباشرة في:
- سلوك خدمات أخرى عند إعادة تشغيلها.
- كود يتم تحميله ديناميكياً أو مُراقب للتغييرات.
- ملفات إعداد أو تهيئة مشتركة.

### 3) تضخيم أثر الخطأ البشري
حتى بدون هجوم، أي تعديل غير مقصود في خدمة واحدة قد يسبب تعارضاً أو تغيراً مفاجئاً في خدمات أخرى تعتمد على نفس الملفات.

## سيناريوهات استغلال واقعية (نموذج تهديد)
1) **اختراق خدمة ذات سطح أقل حماية** → تعديل ملفات مشتركة تؤثر على خدمة حساسة.
2) **تحوير ملفات إعداد** داخل `/app` يؤدي لتسريب بيانات أو تعطيل خدمة أخرى.
3) **حقن كود خبيث** في ملف يُستورد أو يُستخدم عبر أكثر من خدمة.

هذه السيناريوهات لا تتطلب اختراقاً كاملاً للنظام، بل **اختراق خدمة واحدة يكفي** لتوسيع الضرر.

## الفرق بين هذا النمط وثغرة أمنية مباشرة
- **ثغرة مباشرة**: مثل مفتاح سري افتراضي، تؤدي لاختراق آني.
- **مخاطرة معمارية تشغيلية**: مثل مشاركة المستودع بين الخدمات، **تضاعف الأثر** عند حدوث اختراق أو خطأ.

الفرق هنا في طبيعة الخطر: الأول يفتح الباب مباشرة، والثاني يجعل الباب المفتوح مؤدياً إلى كل غرف النظام.

## توصيات هندسية فائقة الدقة
### 1) فصل سياقات البناء
اجعل لكل خدمة سياق بناء منفصل يحتوي فقط على ما تحتاجه تلك الخدمة، بدلاً من استخدام `context: .`.

### 2) إزالة ربط المستودع الكامل في الإنتاج
في البيئات الإنتاجية، يجب أن تأتي الشيفرة من الصورة المبنية فقط، لا من `volumes` مرتبطة بالمستودع.

### 3) تطبيق مبدأ أقل صلاحية للملفات
قلّص نطاق الملفات المتاحة لكل خدمة داخل الحاوية، واحصرها في مسار محدد خاص بالخدمة.

### 4) تعريف حدود ملكية الكود
تحديد واضح لحدود كل خدمة في المستودع (أو فصلها إلى مستودعات/صور مستقلة) يعزز استقلالية التطوير والنشر.

## خطة تطبيقية شاملة على مستوى المستودع
### 1) خريطة فصل سياقات البناء
إعادة تعريف سياق البناء لكل خدمة بحيث تُبنى من مجلد الخدمة مباشرة بدلاً من جذر المستودع. على سبيل المثال:
- `microservices/orchestrator_service/` سياق بناء مخصص.
- `microservices/user_service/` سياق بناء مخصص.
- `microservices/planning_agent/` سياق بناء مخصص.

هذا الإجراء يقلّل مساحة الملفات داخل الصورة ويمنع تضمين ملفات غير مرتبطة بالخدمة.

### 2) ضبط الربط في بيئات التطوير مقابل الإنتاج
تطويرياً يمكن الاحتفاظ بربط جزئي محدد (مثل ربط مجلد الخدمة فقط) لتسريع التطوير، لكن في الإنتاج يجب إزالة ربط المستودع بالكامل والاعتماد على صور مبنية ثابتة.

### 3) تحديد سياسة “امتلاك الملفات”
تحديد صريح لملفات كل خدمة داخل المستودع، مع منع أي خدمة من الوصول إلى مسارات لا تخصها. هذا يتماشى مع مبدأ “كل خدمة جزيرة”.

### 4) مراقبة تلقائية للانحراف المعماري
إضافة فحص دوري (على مستوى CI أو مراجعة التكوين) لرصد عودة استخدام `context: .` أو `.:/app` بشكل شامل، لأن هذه الأنماط هي مؤشر مباشر على تقويض العزل المعماري.

## الحالة التطبيقية الحالية داخل المستودع
### 1) فصل سياقات البناء للخدمات
تم ضبط سياقات البناء لكل خدمة لتشير إلى مجلد الخدمة مباشرة في ملف التشغيل الرئيسي وملف الخدمات المصغّرة، ما يقلّل تضمين ملفات غير ضرورية في الصور ويعزّز العزل بين الخدمات.【F:docker-compose.yml†L46-L184】【F:docker-compose.microservices.yml†L39-L158】

### 2) آلية تحقق تلقائي للانضباط المعماري
أُضيف فحص آلي يضمن أن سياقات البناء تطابق السياسة المسموحة ويمنع العودة إلى ربط المستودع بالكامل داخل الحاويات، ويمكن تشغيله عبر `make compose-isolation` أو مباشرة من السكربت المخصص.【F:Makefile†L20-L153】【F:scripts/validate_compose_isolation.py†L1-L121】

## خاتمة
مشاركة سياق البناء وربط المستودع بالكامل داخل عدة خدمات **ليست مجرد تفصيل تنظيمي**؛ إنها بنية تشغيلية تُعيد توحيد السطح الهجومي وتُقوّض فلسفة الخدمات المصغّرة. لهذا السبب تعتبر هذه المشكلة من أخطر العوامل المعمارية في المشروع، لأنها تحول الاختراقات المحلية إلى تأثيرات منظومية، وتقلّل من فاعلية العزل المقصود في التصميم. معالجة هذا النمط تعيد للنظام قدرته على الصمود، وتخفض المخاطر الأمنية والتشغيلية بشكل جذري.【F:docker-compose.yml†L6-L202】
