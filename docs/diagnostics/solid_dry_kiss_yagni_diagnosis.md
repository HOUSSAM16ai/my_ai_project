# تقرير تشخيصي وفق مبادئ SOLID / DRY / KISS / YAGNI

## الهدف والنطاق
يركّز هذا التقرير على نقاط الضعف المعمارية والتنظيمية التي تؤثر على القابلية للصيانة والاختبار والتوسع، مع ربطها مباشرة بمبادئ SOLID وDRY وKISS وYAGNI.

## التشخيص حسب المبدأ

### 1) SOLID
- **انتهاك مبدأ الاعتماد على التجريد (DIP)**: خدمة إثراء السياق تعتمد مباشرة على وحدات داخلية من خدمة مصغّرة أخرى عبر الاستيراد المباشر (`microservices.research_agent...`) بدل واجهة/عميل API مستقل، ما يخلق اقتراناً حاداً ويجعل التبديل أو النشر المستقل صعباً. هذا يتعارض مع دستور الخدمات المصغّرة الذي يوصي بتقليل المكتبات المشتركة والاعتماد على التكامل عبر الـ APIs. 
- **انتهاك مبدأ المسؤولية الواحدة (SRP)**: `ContextEnricher` يجمع بين عدة مسؤوليات (تنقيح الهدف، الاسترجاع، إعادة الترتيب، واستخراج البيانات من العقد)، إضافةً إلى قراءة إعدادات البيئة وإدارة مسارات فشل متعددة، ما يجعل الكلاس محوراً معقداً يصعب اختباره وصيانته.
- **انتهاك DIP وقابلية الاختبار** في خدمة `LangGraphAgentService`: مُنشئ الخدمة يقوم بإنشاء جميع التبعيات داخل `__init__` (عميل الذكاء، سجل الأدوات، مدير الحالة، المنفّذ، والوكلاء)، ما يصعّب الاستبدال والاختبار ويجعل الخدمة مرتبطة بتطبيقات بعينها بدل واجهات مجرّدة.

### 2) DRY
- **تكرار سجل الموجّهات**: هناك قائمة للموجّهات ضمن `app/api/routers/__init__.py` وأخرى ضمن `app/core/app_blueprint.py` (في `base_router_registry`). هذا التكرار يفرض تحديثين متوازيين لكل إضافة/حذف، ويزيد خطر الانحراف بين المصدرين.

### 3) KISS
- **تعقيد في التجميع الفوري للتبعيات**: أسلوب بناء خدمة `LangGraphAgentService` عبر إنشاء عدة كائنات بداخل `__init__` يرفع العبء الذهني ويعقد عملية التهيئة، بينما يمكن تبسيطه عبر حقن التبعيات أو مصانع مستقلة لتقليل التفاصيل داخل الخدمة.
- **تعقيد مسار إثراء السياق**: دمج مسارات DSPy وLlamaIndex واسترجاع/إعادة ترتيب النتائج داخل خدمة واحدة يخلق تدفقاً مركباً، ويمكن تبسيطه بفصل المسارات في وحدات صغيرة قابلة للتركيب.

### 4) YAGNI
- **ميزات اختيارية ضمن المسار الأساسي**: اعتماد `ContextEnricher` على مفاتيح بيئة لإتاحة DSPy أو LlamaIndex يضيف منطقاً إضافياً في المسار الأساسي حتى عند عدم الحاجة لهذه الميزات. يمكن تأجيل هذه التعقيدات عبر إضافات مفعّلة عند الطلب بدل إبقائها دائماً ضمن المسار الافتراضي.

## مخرجات مقترحة (اختيارية)
- تعريف عقود/واجهات لخدمات الاسترجاع والتنقيح واستبدال الاستيراد المباشر بعميل API.
- فصل مسؤوليات `ContextEnricher` إلى وحدات صغيرة (Refiner / Retriever / Reranker) تُركّب في طبقة تنسيق بسيطة.
- اعتماد سجل موجّهات واحد كمصدر الحقيقة وتوليد باقي القوائم منه.
- استخدام آلية حقن تبعيات لخدمات LangGraph لتبسيط الاختبار والاستبدال.

## الأوامر التي تم استخدامها
- `rg --files -g 'AGENTS.md'`
- `cat docs/ai_skills/crafting-effective-readmes.md`
- `sed -n '1,200p' app/kernel.py`
- `sed -n '1,200p' app/core/app_blueprint.py`
- `sed -n '200,280p' app/core/app_blueprint.py`
- `sed -n '1,200p' app/api/routers/agents.py`
- `sed -n '1,200p' app/api/routers/__init__.py`
- `sed -n '1,200p' app/services/overmind/langgraph/context_enricher.py`
- `sed -n '1,200p' app/services/overmind/langgraph/service.py`
- `sed -n '1,200p' docs/architecture/MICROSERVICES_CONSTITUTION.md`
