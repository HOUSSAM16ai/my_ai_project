# تقرير تدقيق SOLID (موسع)

## 1) خريطة البنية المعمارية

### الطبقات الأساسية
- **واجهة API**: `app/api/routers/` و `app/api/schemas/`
- **طبقة التطبيقات/الاستخدام**: `app/application/` و `app/services/`
- **النواة والمجالات**: `app/core/` و `app/kernel.py`
- **البنية التحتية**: `app/infrastructure/` و `app/middleware/` و `app/telemetry/`

### اتجاه الاعتمادات (Dependency Graph)
- واجهة API تعتمد على **الخدمات/التطبيق**.
- الخدمات تعتمد على **النواة** وعلى منافذ/واجهات عند توفرها.
- البنية التحتية يجب أن تعتمد على **النواة**، ولا العكس.
- النواة لا يجب أن تعتمد على البنية التحتية أو تفاصيل خارجة.

## 2) قائمة مخالفات SOLID (مع أمثلة)

### SRP — Single Responsibility
- خدمات متعددة الأدوار داخل `app/services/`، تجمع بين التخزين والتحليل والتوصيات والتقارير.
- أمثلة: `app/services/admin/performance/service.py` (قبل التفكيك) كانت تجمع تسجيل المقاييس، الإحصائيات، التنبيهات، واقتراحات التحسين في وحدة واحدة.

### OCP — Open/Closed
- مسارات شرطية ثابتة داخل `app/application/use_cases/planning/refactored_planner.py`.
- توجيه ثابت ضمن `app/api/routers/ums.py` بدل سياسات/استراتيجيات قابلة للتمديد.

### LSP — Liskov Substitution
- سجل الاستراتيجيات العام في `app/core/patterns/strategy_pattern/registry.py` يعيد أنواع نتائج متعددة ويحتاج توثيق عقود الاستخدام والتوقعات.

### ISP — Interface Segregation
- بروتوكولات/واجهات واسعة تجبر المستهلك على الاعتماد على وظائف لا يحتاجها، مثل `app/core/patterns/strategy_pattern/registry.py`.

### DIP — Dependency Inversion
- اعتماد مباشر على IO أو مكتبات خارجية في أجزاء من النواة أو الخدمات.
- مثال سابق: التفاعل مع YAML داخل النواة تم فصله في `app/core/yaml_utils.py`، لكن ما زالت مناطق عديدة تعتمد على تنفيذات مباشرة داخل الخدمات.

## 3) خارطة الطريق (Top 10)

1. تفكيك SRP في خدمات `app/services/admin/*` ذات المسؤوليات المتعددة.
2. استخراج منافذ لمصادر البيانات الخارجية في `app/services/*` وربطها عبر حقن.
3. تحويل شرطيات التخطيط في `app/application/use_cases/planning/refactored_planner.py` إلى سياسات قابلة للتمديد.
4. تقسيم سجل الاستراتيجيات العام في `app/core/patterns/strategy_pattern/registry.py` إلى واجهات أصغر.
5. ضبط طبقة `app/api/routers` لتفصل التحقق عن التنسيق.
6. اعتماد منافذ لواجهات البريد/الشبكات/الملفات حيث تظهر في الخدمات.
7. توحيد واجهات القياس والتنبيه في `app/telemetry`.
8. معالجة فجوات النوعية (typing) في `app/services/project_context/refactored`.
9. تحسين حدود طبقة التخزين في `app/core/database`.
10. إضافة اختبارات توصيفية لسلوك الخدمات الحرجة.

## 4) موجات إعادة الهيكلة (A–F)

### Wave A — تفكيك SRP
- **تم**: تفكيك خدمة الأداء الإدارية إلى مخزن مقاييس، حاسبة إحصائيات، محرك اقتراحات، سياسات تنبيه، ومتتبع A/B في `app/services/admin/performance/`.

### Wave B — DIP
- **تم جزئيًا**: إضافة منفذ `IntentDetectorPort` وحقن كاشف النية وسجل المعالجات في `app/services/chat/orchestrator.py`.
- مستهدف: إنشاء منافذ للتكاملات الخارجية ضمن الخدمات العليا.

### Wave C — OCP
- مستهدف: تحويل شرطيات التخطيط والتوجيه إلى استراتيجيات قابلة للحقن.

### Wave D — ISP
- مستهدف: تقسيم الواجهات الواسعة في سجل الاستراتيجيات.

### Wave E — LSP
- مستهدف: توثيق العقود واختبارات الاستبدال في سجلات الاستراتيجيات.

### Wave F — الاتساق والتنظيف
- مستهدف: ضبط اتجاه الاعتمادات وتنظيف التكرارات.

## 5) ملخص قبل/بعد (محدث)

### قبل
- خدمة أداء المحادثات الإدارية تجمع التخزين والتحليل والتنبيه والتوصيات في وحدة واحدة.

### بعد
- نقل مسؤوليات الأداء إلى وحدات متخصصة مع بقاء الواجهة العامة لخدمة الأداء كما هي.

## 6) التنازلات المتبقية
- عدد كبير من المخالفات ما زال قائماً في `app/services/`، `app/application/` وواجهات API.
- الفحوصات النوعية واللينت فاشلة بسبب ديون تقنية سابقة موثقة في خط الأساس.

## 7) قائمة التحقق المرحلية

### SRP
- `app/services/admin/performance/` — مخزن المقاييس، الحاسبة، التنبيهات، الاقتراحات، وتعقب A/B مفصولة.

### DIP
- `app/core/yaml_utils.py` — منافذ YAML مع حقن محلل ومصدر.
- `app/services/chat/ports.py` — منفذ `IntentDetectorPort` مع حقن مكون النية في المنسق.

### OCP
- `YamlParserRegistry` كنقطة تمديد للتحميل.

### ISP
- `YamlParserSelector` كواجهة اختيار صغيرة.

### LSP
- اختبارات YAML تثبت قابلية الاستبدال.
