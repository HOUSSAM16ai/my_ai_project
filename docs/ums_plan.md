# نظام إدارة المستخدمين والأدوار (User Management System) – خطة التنفيذ

## الوضع الحالي (Current State)
- نموذج `User` يستخدم مفتاحًا أوليًا عدديًا (`int`) مع حقول `full_name`, `email`, `password_hash`, `is_admin`, وأختام زمنية؛ لا يوجد حقل حالة أو تفعيل.
- لا توجد جداول أدوار أو صلاحيات أو سجلات تدقيق أو رموز تحديث؛ الأمان يعتمد على حقل `is_admin` فقط.
- مصادقة JWT مبسطة في `AuthBoundaryService` بدون تدوير أو إبطال للرموز وبدون حماية من تصعيد الامتيازات.
- لا يوجد بوابة سياسات للأسئلة ولا حراسة RBAC على المسارات الإدارية؛ الاعتماد على التوجيهات العامة فقط.
- لا توجد ترحيلات حديثة تنشئ بنية RBAC أو سجلات تدقيق؛ الاعتماد على مخطط أساسي موحد عبر `migrations/versions` الحالية.

## التصميم المستهدف (Target Design)
- **النماذج والجداول**: إضافة جداول `roles`, `permissions`, `user_roles`, `role_permissions`, `refresh_tokens`, `audit_log` مع قيود فريدة ومفاتيح خارجية وفهارس تدقيق. توسيع جدول المستخدمين بحقول `is_active` و`status` مع حقل `external_id` (UUID) للاستخدام المستقبلي دون كسر التوافق العددي الحالي.
- **الأمان**: استخدام Argon2 عبر `passlib`، JWT قصيرة العمر مع رموز تحديث دوّارة، وتخزين رموز التحديث مجزأة مع حالات إبطال.
- **الاعتمادات (Dependencies)**: طبقة حراسة مركزية عبر `deps/auth.py` توفر `get_current_user`, `require_roles`, `require_permissions`, مع مسار إعادة توثيق للعمليات الحساسة.
- **RBAC**: مصفوفة صلاحيات دقيقة: `STANDARD_USER` (قراءة الذات وإرسال أسئلة تعليمية)، `ADMIN` (إدارة المستخدمين، الصلاحيات، الإعدادات، السجلات) مع صلاحيات `USERS_READ`, `USERS_WRITE`, `AUDIT_READ`, `AI_CONFIG_READ`, `AI_CONFIG_WRITE`.
- **بوابة السياسات (AI Policy Gate)**: تصنيف الأسئلة إلى مجالات مسموحة (رياضيات، فيزياء، برمجة، هندسة، علوم عامة)، ومنع المحتوى المحظور أو محاولات الحقن، مع تسجيل حظر السياسات في سجل التدقيق.
- **واجهات API**:
  - `/auth/register`, `/auth/login`, `/auth/refresh`, `/auth/logout` بمعدل طلبات محدود وتدوير للرموز.
  - `/admin/users`, `/admin/users/{id}/status`, `/admin/users/{id}/roles`, `/admin/audit`, `/admin/ai-config` محمية بصلاحيات واضحة وحراسة إعادة التوثيق للترقية إلى ADMIN.
  - `/qa/question` مع بوابة السياسات قبل استدعاء طبقة الوكلاء.
- **التوثيق والتتبع**: سجل تدقيق لكل عمليات الإدارة والحظر الأمني، مع خطة ترحيل Alembic واضحة وتوثيق تشغيل محلي.

## خطوات التنفيذ (Implementation Steps)
1. **تجهيز المخطط**: إنشاء ترحيل Alembic يضيف الجداول الجديدة ويحدث جدول المستخدمين بحقول `is_active`, `status`, و`external_id` (UUID) مع فهارس/قيود مناسبة.
2. **طبقة الأمان**: بناء وحدة `app/core/security.py` (أو تعزيز الحالية) لتوليد/تحقق JWT، تجزئة كلمات المرور، وتدوير رموز التحديث مع تخزين مجزأ.
3. **حراس RBAC**: إضافة تبعيات `deps/auth.py` ووحدة خدمات `services/rbac.py` لتقييم الأدوار والصلاحيات واسترداد المستخدم الحالي بشكل موحّد.
4. **خدمات التدقيق والسياسات**: إنشاء `services/audit.py` لتسجيل العمليات الحساسة، و`services/policy.py` لتصنيف الأسئلة وفرض الحظر مع تسجيل الحوادث.
5. **واجهات API**: بناء مسارات `auth`, `admin`, و`qa` بالاعتماد على الحراس الجديدة، مع توثيق عربي وبيانات استجابات متسقة.
6. **الاختبارات**: إضافة اختبارات وحدة وتكامل تشمل تدفق التسجيل/تسجيل الدخول/التحديث/تسجيل الخروج، منع الوصول إلى /admin للمستخدم العادي، منع المحتوى غير المسموح به، وتسجيل التدقيق للأحداث الإدارية.
7. **التوثيق**: تحديث README/وثائق التشغيل لتضمين أوامر `alembic upgrade head`، المصفوفة الصلاحية، ومسارات API، وخطة التراجع.

## مصفوفة الصلاحيات (Permission Matrix)
- `STANDARD_USER`: إنشاء الحساب، تسجيل الدخول/تسجيل الخروج/تحديث الرمز، إدارة الحساب الذاتي، إرسال أسئلة تعليمية مسموحة (مع بوابة سياسة)، عرض السجل الشخصي (اختياري).
- `ADMIN`: جميع عمليات STANDARD بالإضافة إلى إدارة المستخدمين (قراءة/كتابة)، إدارة الأدوار/الصلاحيات، عرض سجلات التدقيق، إدارة إعدادات وتهيئة الذكاء الاصطناعي ضمن الحواجز.

## قائمة المسارات المستهدفة (Route List)
- **Auth**: `POST /auth/register`, `POST /auth/login`, `POST /auth/refresh`, `POST /auth/logout`.
- **Admin (محمي)**: `GET /admin/users`, `POST /admin/users`, `PATCH /admin/users/{id}/status`, `POST /admin/users/{id}/roles`, `GET /admin/audit`, `GET/PUT /admin/ai-config`.
- **Q&A**: `POST /qa/question` مع بوابة سياسة قبل التنفيذ.

## خطة الترحيل والتوافق (Migration & Compatibility)
- الاحتفاظ بالمفتاح العددي الحالي للمستخدمين مع إضافة `external_id` (UUID) للتماشي مع المتطلبات دون كسر العلاقات القائمة.
- توفير تهيئة افتراضية للأدوار/الصلاحيات والبذور الأولية (seed) بعد الترحيل لتجنب الفراغ الأمني.
- ضمان أن مسارات الأمن الحالية تظل متوافقة حتى اكتمال الانتقال مع تمكين الحراس الجديدة بشكل تدريجي.

## التنفيذ المنجز (Current Implementation)
- تم تطبيق ترحيل `20260101_add_rbac_ums_schema` الذي يضيف جداول الأدوار والصلاحيات وسجلات التدقيق ورموز التحديث مع فهارس الربط والحذف المتسلسل.
- تم توسيع نموذج المستخدم بحقول `external_id` النصية، وحالة الحساب، ومؤشرات التفعيل لتفادي تعارضات نوع UUID في SQLite.
- أضيفت خدمة مصادقة JWT مع تدوير رموز التحديث وحراسة RBAC عبر `services/auth_service.py` و`services/rbac.py`، مع بوابة سياسات الأسئلة في `services/policy.py` وتسجيل تدقيق مركزي.
- تم توفير موجه `/auth` و`/admin` و`/qa` الجديد في `app/api/routers/ums.py` مع تبعيات `app/deps/auth.py` لضمان الفصل بين الطبقات.
- تمت إضافة اختبارات تكاملية في `tests/api/test_ums_rbac.py` تغطي التدفق الكامل والتصعيدات المرفوضة.
- أضيفت حماية معدل طلبات لمسارات التسجيل/الدخول/التحديث مع تسجيل أحداث التدقيق لحالات الفشل أو إعادة استخدام رموز التحديث لمنع هجمات التخمين وإعادة التشغيل.
